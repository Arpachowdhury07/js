import { createMetadata } from "@doc";

export const metadata = createMetadata({
  title: "thirdweb Insight Para Agentes y LLMs",
  description:
    "Documentación de consulta de thirdweb Insight formateada para su uso con LLMs y agentes",
  image: {
    title: "Insight",
    icon: "insight",
  },
});

# Thirdweb Insight

Insight es una herramienta poderosa que te permite recuperar datos de blockchain de cualquier cadena EVM, enriquecerlos con metadatos y transformarlos usando lógica personalizada. Ya sea que estés construyendo un sistema de inventario para juegos, rastreando métricas DeFi o analizando colecciones de NFTs, Insight facilita obtener los datos que necesitas con simples llamadas a la API.

## Aspectos a Tener en Cuenta

- **Límites de Tasa**: La API tiene límites de tasa basados en tu nivel de autenticación. Monitorea tu uso e implementa lógica de reintento adecuada.

- **Paginación**: Al recuperar grandes conjuntos de datos, utiliza parámetros de paginación (`page` y `limit`) para evitar tiempos de espera y gestionar eficientemente el tamaño de las respuestas.

- **Selección de Cadena**: Verifica siempre que estás consultando el Chain ID correcto. Usar un Chain ID incorrecto devolverá un error 404.

- **Actualización de Datos**: Puede haber un ligero retraso entre los eventos on-chain y su disponibilidad en la API debido a los tiempos de confirmación de bloques.

- **Manejo de Errores**: Implementa un manejo adecuado de errores tanto para errores HTTP (400/500) como para problemas de red. Considera implementar reintentos para fallas transitorias.

- **Optimización de Consultas**:
  - Utiliza filtros específicos para reducir el tamaño de la respuesta y mejorar el rendimiento.
  - Evita rangos de fechas demasiado amplios cuando sea posible.
  - Considera usar agregaciones para conjuntos de datos grandes.

- **Autenticación**: Mantén tus credenciales de autenticación seguras y no las expongas en código del lado del cliente.

- **Procesamiento de Respuestas**: Algunos valores numéricos se devuelven como cadenas para mantener la precisión. Conviértelos adecuadamente en tu aplicación.

## API URL

```typescript
const baseUrl = `https://{{chainId}}.insight.thirdweb.com`;
```

## Autenticación

La API admite tres métodos de autenticación:

```typescript
// 1. Autenticación por Header
const headers = {
	"x-client-id": "{{clientId}}", // thirdweb Client ID
};

// 2. Parámetro de Consulta
const url = `https://{{chainId}}.insight.thirdweb.com/v1/events?clientId={{clientId}}`;

// 3. Bearer Token
const headers = {
	Authorization: "Bearer {{jwtToken}}",
};

// Ejemplo utilizando fetch con autenticación por header
async function getEvents() {
	const response = await fetch(`https://{{chainId}}.insight.thirdweb.com/v1/events`, {
		headers: {
			"x-client-id": "{{clientId}}",
		},
	});
	return await response.json();
}
```

## Conceptos Básicos

### Chain IDs

La API admite Chain IDs en el siguiente formato:

```typescript
interface ChainConfig {
	chainId: number;  // Chain ID de la red que deseas consultar
}

// Ejemplo: Usando una cadena específica
const chainId = "{{chainId}}"; // Reemplaza con el Chain ID que desees
const baseUrl = `https://{{chainId}}.insight.thirdweb.com`;
```

### Estructura Básica de Respuesta

```typescript
interface BaseResponse<T> {
  data: T[];
  meta: {
    chain_id: number;     // Required
    page: number;         // Required
    limit: number;        // Required
    total_items: number;  // Required
    total_pages: number;  // Required
    address?: string;     // Optional
    signature?: string;   // Optional
  }
}

// Ejemplo de respuesta al obtener eventos
{
  "data": [
    {
      "chain_id": 1,
      "block_number": "17859301",
      "transaction_hash": "0x123...",
      "address": "0x456...",
      "data": "0x789...",
      "topics": ["0xabc..."]
    }
  ],
  "meta": {
    "chain_id": 1,
    "page": 0,
    "limit": 20,
    "total_items": 150,
    "total_pages": 8
  }
}
```

## Ejemplos de API

### API de Eventos

```typescript
// 1. Obtener Todos los Eventos
async function getAllEvents(): Promise<BaseResponse<Event>> {
	const response = await fetch(`https://{{chainId}}.insight.thirdweb.com/v1/events`, {
		headers: { "x-client-id": "{{clientId}}" },
	});
	return await response.json();
}

// 2. Obtener Eventos de Contrato con Filtros
async function getContractEvents(contractAddress: string): Promise<BaseResponse<Event>> {
	const params = new URLSearchParams({
		filter_block_number_gte: "{{blockNumber}}",
		sort_by: "block_timestamp",
		sort_order: "desc",
		limit: "50",
	});

	const url = `https://{{chainId}}.insight.thirdweb.com/v1/events/${contractAddress}?${params}`;
	const response = await fetch(url, {
			headers: { "x-client-id": "{{clientId}}" },
	});
	return await response.json();
}
```

### API de Saldo de Tokens

```typescript
// 1. Obtener Balances de ERC20
async function getERC20Balances(ownerAddress: string): Promise<ERC20Response> {
	const response = await fetch(
		`https://{{chainId}}.insight.thirdweb.com/v1/tokens/erc20/${ownerAddress}`,
		{ headers: { "x-client-id": "{{clientId}}" } },
	);
	const data = await response.json();
	// Example response:
	// {
	//   "data": [
	//     {
	//       "tokenAddress": "0x123...",
	//       "balance": "1000000000000000000"
	//     }
	//   ]
	// }
	return data;
}

// 2. Obtener Balances de NFTs
async function getNFTBalances(ownerAddress: string) {
	const response = await fetch(
		`https://{{chainId}}.insight.thirdweb.com/v1/tokens/erc721/${ownerAddress}`,
		{ headers: { "x-client-id": "{{clientId}}" } },
	);
	const data = await response.json();
	// Example response:
	// {
	//   "data": [
	//     {
	//       "collectionAddress": "0x456...",
	//       "tokenId": "1",
	//       "balance": "1"
	//     }
	//   ]
	// }
	return data;
}
```

### Usando Filtros

```typescript
// Ejemplo: Obtener eventos con filtros complejos
async function getFilteredEvents() {
	const params = new URLSearchParams({
		// Block filters
		filter_block_number_gte: "{{startBlock}}",
		filter_block_number_lte: "{{endBlock}}",

		// Time filters
		filter_block_timestamp_gte: "{{startTimestamp}}",

		// Transaction filters
		filter_from_address: "{{fromAddress}}",
		filter_value_gte: "{{minValue}}", // 1 ETH

		// Pagination
		page: "0",
		limit: "20",

		// Sorting
		sort_by: "block_timestamp",
		sort_order: "desc",
	});

	const response = await fetch(
		`https://{{chainId}}.insight.thirdweb.com/v1/events?${params}`,
		{ headers: { "x-client-id": "{{clientId}}" } },
	);
	return await response.json();
}
```

### Manejo de Errores

```typescript
async function safeApiCall() {
	try {
		const response = await fetch(`https://{{chainId}}.insight.thirdweb.com/v1/events`, {
			headers: { "x-client-id": "{{clientId}}" },
		});

		if (!response.ok) {
			const errorData = await response.json();
			// Example error response:
			// { "error": "Invalid client ID" }
			throw new Error(errorData.error);
		}

		return await response.json();
	} catch (error) {
		console.error("API Error:", error.message);
		throw error;
	}
}
```

## Referencia de API

### API de Eventos

1. **Obtener Todos los Eventos**

```typescript
GET https://{{chainId}}.insight.thirdweb.com/v1/events
```

2. **Obtener Eventos de Contrato**

```typescript
GET https://{{chainId}}.insight.thirdweb.com/v1/events/:contractAddress
```

3. **Obtener Tipo de Evento Específico**

```typescript
GET https://{{chainId}}.insight.thirdweb.com/v1/events/:contractAddress/:signature
```

### API de Transacciones

1. **Obtener Todas las Transacciones**

```typescript
GET https://{{chainId}}.insight.thirdweb.com/v1/transactions
```

2. **Obtener Transacciones de Contrato**

```typescript
GET https://{{chainId}}.insight.thirdweb.com/v1/transactions/:contractAddress
```

3. **Obtener Tipo de Transacción Específico**

```typescript
GET https://{{chainId}}.insight.thirdweb.com/v1/transactions/:contractAddress/:signature
```

### API de Saldo de Tokens

1. **ERC20 Balances**

```typescript
GET https://{{chainId}}.insight.thirdweb.com/v1/tokens/erc20/:ownerAddress

interface ERC20Response {
  data: ERC20Balance[];
}

interface ERC20Balance {
  tokenAddress: string;
  balance: string;
}
```

2. **Balances de ERC721 y ERC1155**

```typescript
GET https://{{chainId}}.insight.thirdweb.com/v1/tokens/erc721/:ownerAddress
GET https://{{chainId}}.insight.thirdweb.com/v1/tokens/erc1155/:ownerAddress

interface TokenBalance {
  data: NFTBalance[];
}

interface NFTBalance {
  collectionAddress: string;
  tokenId: string;
  balance: string;
}
```

## Parámetros de Consulta

### Parámetros Comunes

```typescript
interface CommonQueryParams {
	page?: number; // Default: 0
	limit?: number; // Default: 20, must be > 0
	sort_by?: "block_number" | "block_timestamp" | "transaction_index";
	sort_order?: "asc" | "desc";
	group_by?: string;
	aggregate?: string[];
}
```

### Tipos de Filtros

1. **Filtros de Bloques**

```typescript
interface BlockFilters {
	filter_block_number?: number; // Example: 1000000
	filter_block_number_gte?: number; // Example: 1000000
	filter_block_number_gt?: number; // Example: 1000000
	filter_block_number_lte?: number; // Example: 1000000
	filter_block_number_lt?: number; // Example: 1000000
	filter_block_hash?: string; // Example: "0x3a1fba5..."
}
```

2. **Filtros de Tiempo**

```typescript
interface TimeFilters {
	filter_block_timestamp?: number; // Example: 1715222400
	filter_block_timestamp_gte?: number; // Example: 1715222400
	filter_block_timestamp_gt?: number; // Example: 1715222400
	filter_block_timestamp_lte?: number; // Example: 1715222400
	filter_block_timestamp_lt?: number; // Example: 1715222400
}
```

3. **Filtros de Transacción**

```typescript
interface TransactionFilters {
	filter_transaction_index?: number;
	filter_transaction_hash?: string;
	filter_from_address?: string;
	filter_value?: number;
	filter_gas_price?: number;
	filter_gas?: number;
	// Additional gte, gt, lte, lt variants for numeric fields
}
```

## Manejo de Errores

Todos los endpoints devuelven respuestas de error estándar para los códigos de estado 400 y 500:

```typescript
// 400 Bad Request
// 500 Internal Server Error
interface ErrorResponse {
	error: string; // Required
}
```
