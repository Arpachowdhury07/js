import { Details, Callout, createMetadata } from "@doc";

export const metadata = createMetadata({
	title: "InAppWallet.Create | SDK de Thirdweb para .NET",
	description:
		"Instancia un InAppWallet para autenticación segura de usuarios e interacción.",
});

# InAppWallet.Create

Crea una instancia de `InAppWallet` utilizando el correo electrónico, número de teléfono u OAuth de un usuario. Este tipo de billetera facilita la autenticación segura del usuario a través de verificación OTP, lo que la hace adecuada para aplicaciones orientadas al cliente donde no es ideal manejar claves privadas directamente.

## Métodos de Inicio de Sesión

Las billeteras In-App soportan una variedad de métodos de inicio de sesión:
- Correo electrónico (Inicio de sesión con OTP)
- Teléfono (Inicio de sesión con OTP)
- Redes sociales (Google, Apple, Facebook, Telegram, Farcaster, Line, Github, Twitch, etc.)
- SIWE (Iniciar sesión con Ethereum)
- Autenticación personalizada (compatible con OIDC)
- Autenticación personalizada (Punto final de autenticación genérico)
- Invitado (Incorporación fácil, vincula otras cuentas más tarde)

## Uso

```csharp
// Correo electrónico
var wallet = await InAppWallet.Create(client: client, email: "userEmail");

// Teléfono
var wallet = await InAppWallet.Create(client: client, phoneNumber: "+1234567890");

// Google, Apple, Facebook, etc.
var wallet = await InAppWallet.Create(client: client, authProvider: AuthProvider.Google);

// SIWE
var wallet = await InAppWallet.Create(client: client, authProvider: AuthProvider.Siwe, siweSigner: anyExternalWallet);

// Autenticación personalizada - JWT
var wallet = await InAppWallet.Create(client: client, authProvider: AuthProvider.JWT);

// Autenticación personalizada - AuthEndpoint
var wallet = await InAppWallet.Create(client: client, authProvider: AuthProvider.AuthEndpoint);

// Inicio de sesión como invitado
var wallet = await InAppWallet.Create(client: client, authProvider: AuthProvider.Guest);

// Reanudación de sesión soportada para todos los métodos
var isConnected = await wallet.IsConnected();

// Si no está conectado, inicia el flujo de inicio de sesión según el proveedor de autenticación que estés usando

// Correo electrónico y teléfono (OTP)
await wallet.SendOTP(); // y obtener el otp
var address = await wallet.LoginWithOtp("userEnteredOTP"); // prueba con catch y vuelve a intentar si es necesario

// Redes sociales (OAuth)
var address = await wallet.LoginWithOauth(
    // Ejemplo para aplicación de consola en Windows, adaptable a cualquier entorno
    isMobile: false,
    browserOpenAction: (url) =>
    {
        var psi = new ProcessStartInfo { FileName = url, UseShellExecute = true };
        _ = Process.Start(psi);
    },
    mobileRedirectScheme: "myBundleId://"
);

// SIWE (Billetera)
var address = await siweWallet.LoginWithSiwe(chainId: 1);

// Autenticación personalizada (JWT)
var address = await wallet.LoginWithCustomAuth(jwt: "myjwt");

// Autenticación personalizada (AuthEndpoint)
var address = await wallet.LoginWithAuthEndpoint(payload: "mypayload");

// Inicio de sesión como invitado (Incorporación fácil)
var address = await wallet.LoginWithGuest();
```

<Callout variant="info" title="Uso en el Lado del Cliente">
  Esta billetera está diseñada para uso en el lado del cliente en aplicaciones donde el acceso directo a las claves privadas del usuario no es seguro ni necesario. Utiliza OTP para una autenticación segura, permitiendo a los usuarios interactuar con aplicaciones blockchain de manera fluida.
</Callout>
<Details summary="Parámetros">

### client (requerido)

Una instancia de `ThirdwebClient`.

### email (opcional)

La dirección de correo electrónico del usuario. Es requerido si no se proporciona `phoneNumber`.

### phoneNumber (opcional)

El número de teléfono del usuario. Es requerido si no se proporciona `email`.

### authProvider (opcional)

El proveedor de OAuth que se utilizará para la autenticación. Los valores soportados son `AuthProvider.Google`, `AuthProvider.Apple`, `AuthProvider.Facebook`.

### storageDirectoryPath (opcional)

La ruta al directorio donde se almacenarán los datos de la billetera. El valor predeterminado es el directorio de datos de la aplicación.

</Details>

<Details summary="Valor de Retorno">

### InAppWallet

Devuelve una instancia de InAppWallet, inicializada para el usuario según el correo electrónico o número de teléfono proporcionado. Esta billetera está lista para la autenticación OTP y futuras interacciones con blockchain.

</Details>

## Flujo de Autenticación OTP

El flujo de autenticación OTP implica enviar un OTP al correo electrónico o teléfono del usuario y luego verificar el OTP para completar la autenticación:

**Enviar OTP:** Inicia el proceso de inicio de sesión llamando a `SendOTP` en la instancia de InAppWallet. Esto envía un OTP al correo electrónico o número de teléfono del usuario.
```csharp
await wallet.SendOTP();
```

**Enviar OTP:** Una vez que el usuario recibe el OTP, lo envía de vuelta a la aplicación, que luego llama a `LoginWithOtp` en la instancia de InAppWallet para verificar el OTP y completar el proceso de inicio de sesión.

```csharp
var address = await wallet.LoginWithOtp("userEnteredOTP");
// Si esto falla, puedes capturarlo y pedir otro OTP para intentar de nuevo el proceso de inicio de sesión.
```

## Ejemplo

Aquí tienes un ejemplo de cómo crear un `InAppWallet` con el correo electrónico de un usuario y completar el flujo de autenticación OTP:

```csharp
// Crear la billetera InAppWallet como firmante para desbloquear la autenticación web2
var inAppWallet = await InAppWallet.Create(client: client, email: "email@email.com"); // o email: null, phoneNumber: "+1234567890"

// Reanudar sesión (si la billetera `InAppWallet` no estaba iniciada)
if (!await inAppWallet.IsConnected())
{
    await inAppWallet.SendOTP();
    Console.WriteLine("Por favor, ingrese el OTP.");
    var otp = Console.ReadLine();
    var inAppWalletAddress = await inAppWallet.LoginWithOtp(otp); // prueba con catch y vuelve a intentar si es necesario
}

Console.WriteLine($"Dirección de InAppWallet: {await inAppWallet.GetAddress()}");

// Firmar un mensaje
var message = "¡Hola, Thirdweb!";
var signature = await wallet.PersonalSign(message);
Console.WriteLine($"Firma: {signature}");
```

**Nota:** InAppWallet aprovecha la seguridad de la autenticación basada en OTP para garantizar una experiencia segura y fácil de usar en aplicaciones blockchain.

## Flujo de Autenticación OAuth

**LoginWithOauth:** Inicia el proceso de inicio de sesión llamando a `LoginWithOauth` en la instancia de InAppWallet. Esto redirige al usuario a la página de inicio de sesión del proveedor de OAuth.

```csharp
// Ejemplo para aplicación de consola en Windows
var address = await inAppWallet.LoginWithOauth(
    isMobile: false,
    browserOpenAction: (url) =>
    {
        var psi = new ProcessStartInfo { FileName = url, UseShellExecute = true };
        _ = Process.Start(psi);
    },
);

// Ejemplo para Godot en modo independiente
var address = await ThirdwebManager.Instance.InAppWallet.LoginWithOauth(
        isMobile: OS.GetName() == "Android" || OS.GetName() == "iOS",
        browserOpenAction: (url) => OS.ShellOpen(url),
        mobileRedirectScheme: "thirdweb://"
);
```

<Details summary="Parámetros">

### isMobile

Un `bool` que indica si la aplicación se está ejecutando en una plataforma móvil.

### browserOpenAction

Una `Action<string>` que abre la página de inicio de sesión del proveedor de OAuth en un navegador.

### mobileRedirectScheme

El esquema de redirección a usar para plataformas móviles. El valor predeterminado es `"thirdweb://"`. 

### browser

Una instancia de `IThirdwebBrowser` que se utiliza para el proceso de inicio de sesión OAuth. El valor predeterminado es `null`.

### cancellationToken

Un `CancellationToken` para cancelar la operación. El valor predeterminado es `default`.

</Details>

<Details summary="Valor de Retorno">

### string

La dirección de InAppWallet como una cadena hexadecimal `string`.

</Details>

## Ejemplo

Aquí tienes un ejemplo de cómo crear un `InAppWallet` usando OAuth.

```csharp
// Crear la billetera InAppWallet como firmante para desbloquear la autenticación web2
var inAppWallet = await InAppWallet.Create(client: client, authProvider: AuthProvider.Google);

// Reanudar sesión (si la billetera `InAppWallet` no estaba iniciada)
if (!await inAppWallet.IsConnected())
{
    try {
        var address = await inAppWallet.LoginWithOauth(
            isMobile: false,
            browserOpenAction: (url) =>
            {
                var psi = new ProcessStartInfo { FileName = url, UseShellExecute = true };
                _ = Process.Start(psi);
            },
        );
        Console.WriteLine($"Inicio de sesión OAuth exitoso. Dirección de InAppWallet: {address}");
    } catch (Exception ex) {
        Console.WriteLine($"Error en el inicio de sesión OAuth: {ex.Message}");
        return;
    }
}
```

**Nota:** La API `LoginWithOauth` permite un manejo personalizado del navegador, lo que la hace adecuada para diversos tipos de aplicaciones y plataformas.

## Identidad Unificada - Vinculación de Cuentas

InAppWallet soporta la vinculación de múltiples métodos de autenticación a una sola cuenta de usuario. Esta función permite a los usuarios acceder a su cuenta utilizando diferentes métodos de autenticación, como correo electrónico, teléfono o OAuth, sin necesidad de crear cuentas separadas para cada método.

### Vinculación de Cuentas

```csharp
var inAppWalletMain = await InAppWallet.Create(client: client, authProvider: AuthProvider.Google);
if (!await inAppWalletMain.IsConnected())
{
    _ = await inAppWalletMain.LoginWithOauth(
        isMobile: false,
        (url) =>
        {
            var psi = new ProcessStartInfo { FileName = url, UseShellExecute = true };
            _ = Process.Start(psi);
        },
        "thirdweb://",
        new InAppWalletBrowser()
    );
}
Console.WriteLine($"Main InAppWallet address: {await inAppWalletMain.GetAddress()}");

// Prepare Telegram
var socialWallet = await InAppWallet.Create(client: client, authProvider: AuthProvider.Telegram);
// Link Telegram
_ = await inAppWalletMain.LinkAccount(walletToLink: socialWallet,);

// Prepare Phone
var phoneWallet = await InAppWallet.Create(client: client, phoneNumber: "+1234567890");
_ = await phoneWallet.SendOTP();
var otp = Console.ReadLine();
// Link Phone
_ = await inAppWalletMain.LinkAccount(walletToLink: phoneWallet, otp: otp);
```

### Obtener Cuentas Vinculadas

```csharp
List<LinkedAccount> linkedAccounts = await inAppWalletMain.GetLinkedAccounts();
```

### Desvinculación de Cuentas

```csharp
List<LinkedAccount> linkedAccounts = await inAppWallet.GetLinkedAccounts();
List<LinkedAccount> linkedAccountsAfterUnlinking = await inAppWallet.UnlinkAccount(linkedAccounts[0]);
```