import { createMetadata, Details } from "@doc";
import { Callout } from "@doc";

export const metadata = createMetadata({
	title: "Backend Wallets | thirdweb Engine",
	description:
		"Engine performs blockchain actions using backend wallets that you own and manage.",
});

# Billeteras Backend

Engine realiza acciones en blockchain utilizando billeteras backend que tú posees y gestionas.

Existen múltiples opciones para proteger las billeteras backend.

## Billeteras Backend Inteligentes

Las billeteras backend inteligentes son la forma recomendada de realizar operaciones en blockchain con Engine. Cada billetera backend inteligente consiste en una EOA (gestionada internamente por Engine) y una cuenta inteligente (utilizando la implementación predeterminada de cuentas de thirdweb).

### Beneficios

Las billeteras backend inteligentes heredan los beneficios de las cuentas inteligentes y ofrecen varias ventajas sobre las EOA tradicionales:

- **Gestión de Gas**: El paymaster integrado elimina la necesidad de mantener tokens de gas. Esto significa que nunca necesitas tener cripto o recargar gas.
- **Mejor Gestión de Nonces**: Las cuentas inteligentes utilizan nonces multidimensionales, que son más eficientes que las EOA.
- **Integración Sencilla**: Funciona con todos los endpoints existentes de Engine sin necesidad de realizar cambios en el código.

### Cómo funciona

La cuenta inteligente se despliega automáticamente la primera vez que envías una transacción en una cadena. No necesitas preocuparte por desplegar o gestionar la cuenta inteligente: Engine se encarga de todo en segundo plano. Todas las transacciones se envían como UserOperations al contrato EntryPoint en la cadena.

<Details summary="¿En qué se diferencian las billeteras backend inteligentes de las características AA existentes de Engine?">
	A diferencia de la [implementación previa de abstracción de cuentas en
	Engine](account-abstraction), donde tenías que gestionar tanto la dirección de
	la cuenta (`x-account-address`) como la dirección de la billetera backend
	(`x-backend-wallet-address`) por separado, las billeteras backend inteligentes
	simplifican este proceso. Ahora, la dirección de la billetera backend es la
	misma dirección de la cuenta inteligente.
</Details>

<Details summary="¿Cuándo no usar las billeteras backend inteligentes?">
	En este momento, las billeteras backend inteligentes no permiten importar una
	cuenta inteligente. En casos de uso donde necesites importar una cuenta
	inteligente (como con claves de sesión), deberías usar las [características AA
	de Engine que utilizan el encabezado `x-account-address`](account-abstraction).
</Details>

### Tipos de Configuración

- `smart:local` - Cuenta inteligente respaldada por una clave local.
- `smart:aws-kms` - Cuenta inteligente respaldada por AWS KMS.
- `smart:gcp-kms` - Cuenta inteligente respaldada por Google Cloud KMS.

Para las opciones de AWS y Google Cloud KMS, sigue las instrucciones de configuración en las secciones correspondientes a continuación.

### Precios

Las billeteras backend inteligentes no tienen costos adicionales para usarlas con tu instancia de Engine. Las transacciones enviadas desde billeteras backend inteligentes siguen el [mismo modelo de facturación que las transacciones regulares de abstracción de cuentas con thirdweb](/connect/account-abstraction/infrastructure#pricing--billing).
Las cuentas inteligentes deben desplegarse en cada cadena. Esto genera costos de gas y se factura a tu cuenta como cualquier otra transacción.

## Billetera Local

Una [billetera local](/references/wallets/v2/LocalWallet) es una billetera creada o importada desde una clave privada. Asegúrate de respaldar tu clave privada antes de realizar transacciones con una billetera local en un entorno de producción.

> Las claves privadas de las billeteras locales se almacenan cifradas en la base de datos de Engine. Por razones de seguridad, las claves privadas no pueden ser exportadas.

## Billetera AWS KMS

Una [billetera AWS KMS](/references/wallets/v2/AwsKmsWallet) es una billetera almacenada de forma segura en tu cuenta de AWS. Engine puede crear y transaccionar con la billetera, pero no eliminarla.

#### Configuración

1. [Crea un usuario IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html#id_users_create_console) con acceso programático.
1. [Otorga los siguientes permisos KMS](https://docs.aws.amazon.com/kms/latest/developerguide/control-access.html) a este usuario:
   - `kms:CreateKey`
   - `kms:GetPublicKey`
   - `kms:Sign`
   - `kms:CreateAlias`
   - `kms:Verify`
1. En la página del usuario, navega a **Credenciales de seguridad > Claves de acceso**.
1. Selecciona **Crear clave de acceso** para obtener una **Clave de acceso** y una **Clave secreta**.
1. En el dashboard, navega a **Configuración > Billeteras Backend**.
1. Selecciona **AWS KMS** y proporciona lo siguiente:
   - Clave de acceso (ejemplo: `AKIA...`)
   - Clave secreta (ejemplo: `UW7A...`)
   - Región (ejemplo: `us-west-1`)

#### Importar una billetera existente

1. Asegúrate de que tu [clave KMS esté creada](https://docs.aws.amazon.com/kms/latest/developerguide/create-keys.html) con los siguientes ajustes:
   - Tipo de clave: `Asimétrica`.
   - Especificación de clave: `ECC_SECG_P256K1`.
   - Uso de la clave: `Firmar y verificar`.
1. En el dashboard, navega a **Vista General > Billeteras Backend**.
1. Selecciona **Importar** y proporciona lo siguiente:
   - ID de la clave AWS KMS (ejemplo: `0489da75-9830-4a5a-97e3-e4a6df7775b3`).
   - ARN de la clave AWS KMS (ejemplo: `arn:aws:kms:us-west-1:632186309261:key/0489da75-9830-4a5a-97e3-e4a6df7775b3`).

## Billetera Google Cloud KMS

#### Configuración

1. [Habilita la API de Google KMS](https://cloud.google.com/kms/docs/create-encryption-keys#before-you-begin) para tu cuenta de GCP.
1. [Crea una Cuenta de Servicio](https://cloud.google.com/iam/docs/service-accounts-create).
1. Navega a la página de [IAM](https://console.cloud.google.com/iam-admin/iam). Encuentra la cuenta de servicio y selecciona **Editar Principal** para agregar los siguientes roles:
   - Administrador de Cloud KMS (Cloud KMS Admin)
   - Firmante/Verificador de CryptoKey de Cloud KMS (Cloud KMS CryptoKey Signer/Verifier)
1. Navega a la página de [Cuentas de Servicio](https://console.cloud.google.com/iam-admin/serviceaccounts). Selecciona la cuenta de servicio creada anteriormente.
1. Ve a la pestaña **Keys**. Selecciona **Add Key > Create new key**.
1. Selecciona **JSON** para descargar el archivo JSON. Este archivo contiene la clave privada en texto plano.
1. En el dashboard, navega a **Configuración > Billeteras Backend**.
1. Selecciona **Google KMS** y proporciona lo siguiente:

<Details id="gcpApplicationProjectId" summary="gcpApplicationProjectId">

Este es el ID del proyecto GCP donde se creó la clave.

**Dónde encontrarlo**:

- Navega a la consola de Google Cloud.
- Haz clic en el menú desplegable de proyectos en la parte superior de la página.
- El ID del proyecto se muestra debajo del nombre de tu proyecto.

</Details>

<Details id="gcpKmsLocationId" summary="gcpKmsLocationId">

Este es el lugar donde se creó el keyring (por ejemplo, us-central1, europe-west1).

**Dónde encontrarlo**:

- En la consola de Google Cloud, ve a **Security > Cryptographic Keys**.
- Haz clic en el keyring que contiene tu clave.
- La ubicación se muestra en el campo de Ubicación (Location).

</Details>

<Details id="gcpKmsKeyRingId" summary="gcpKmsKeyRingId">

Este es el ID del keyring donde se almacena tu clave.

**Dónde encontrarlo**:

- En la consola de Google Cloud, ve a **Security > Cryptographic Keys**.
- Selecciona el keyring que contiene tu clave.
- El ID del KeyRing se muestra en la lista o en la URL.

</Details>

<Details id="gcpApplicationCredentialEmail" summary="gcpApplicationCredentialEmail">

Este es el correo electrónico asociado a la cuenta de servicio utilizada para acceder a la clave KMS.

**Dónde encontrarlo**:

- En la consola de Google Cloud, ve a **IAM & Admin > Service Accounts**.
- Encuentra la cuenta de servicio que estás utilizando. Su correo electrónico tendrá el formato: `name@project.iam.gserviceaccount.com`.

</Details>

<Details id="gcpApplicationCredentialPrivateKey" summary="gcpApplicationCredentialPrivateKey">

Esta es la clave privada de la cuenta de servicio utilizada para autenticar solicitudes a la API.

**Dónde encontrarlo**:

- Abre el archivo JSON descargado anteriormente.
- Copia el valor del campo `private_key`.

</Details>


#### Importar una billetera existente

1. Asegúrate de que tu [keyring esté creado](https://cloud.google.com/kms/docs/create-key-ring) con los siguientes ajustes:
   - Propósito: `Asymmetric sign`.
   - Algoritmo: `Elliptic Curve P-256 - SHA256 Digest`.
1. En el dashboard, navega a **Vista General > Billeteras Backend**.
1. Selecciona **Importar** y proporciona lo siguiente:
   - ID de la clave GCP KMS (ejemplo: `0489da75-9830-4a5a-97e3-e4a6df7775b3`).
   - ID de la versión GCP KMS (ejemplo: `1`).

## Crear una billetera

Para las billeteras AWS o Google Cloud KMS, debes proporcionar tus credenciales.

1. En el dashboard, navega a **Vista General > Billeteras Backend**.
1. Selecciona **Crear**.
1. (Opcional) Proporciona una etiqueta para organizar tus billeteras.


## Importar una billetera

Para las billeteras AWS o Google Cloud KMS, debes proporcionar tus credenciales.

1. En el dashboard, navega a **Vista General > Billeteras Backend**.
1. Selecciona **Importar**.
1. Proporciona los campos solicitados.
   - Consulta las instrucciones anteriores para tipos específicos de billeteras.

## Listar billeteras

En el dashboard, navega a **Vista General > Billeteras Backend** para ver las billeteras creadas o importadas en Engine.

## Mejores prácticas

- Se recomienda usar billeteras AWS o Google Cloud KMS para entornos de producción. Las claves privadas nunca se exponen y la billetera está respaldada de forma segura por el proveedor en la nube.
- Utiliza etiquetas y múltiples billeteras backend para organizar y rastrear su uso.
  - Ejemplo: Usa una billetera para pagar a creadores en tu plataforma y otra para realizar airdrops de NFTs a usuarios.
- Si tus billeteras requieren recargas regulares de gas o tokens ERC20, considera usar una billetera backend separada de "almacenamiento de fondos" que transfiera fondos a otras billeteras mediante la interfaz del dashboard o la API.
