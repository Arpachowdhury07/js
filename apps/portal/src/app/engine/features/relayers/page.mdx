import { Details, Callout, DocImage } from "@doc";
import Relayer1 from "../../assets/relayer-1.png";
import { createMetadata } from "@doc";

export const metadata = createMetadata({
	title: "Relayers | thirdweb Engine",
	description:
		"Use Engine to deploy, manage, and transact with smart accounts on behalf of your users",
});

# Relayers

Usa Engine como un intermediario para patrocinar el gas de las transacciones en nombre de tus usuarios. Los usuarios firman una transacción con su propia billetera (sin necesidad de gas) y pagan las [comisiones de gas](/glossary/gas) con una billetera backend de Engine.

Eliminar la necesidad de que tus usuarios adquieran gas mejora significativamente la experiencia del usuario y el alcance de tu dApp.

## Casos de uso

Permite a los usuarios reclamar, transferir, listar o quemar NFTs sin gas. [Aprende más sobre las transacciones sin gas.](/glossary/gasless-transactions)

## Requisitos

- Tu instancia de Engine tiene una [billetera backend](/engine/features/backend-wallets) con fondos.
- El contrato objetivo debe ser compatible con uno de:
  - [Transacciones meta EIP-2771](https://eips.ethereum.org/EIPS/eip-2771) \*
  - [Aprobación de permisos EIP-2612](https://eips.ethereum.org/EIPS/eip-2612)
  - [Transacciones meta Polygon](https://docs.polygon.technology/pos/concepts/transactions/meta-transactions/)

\* El contrato objetivo debe confiar en un intermediario que implemente los métodos `verify` y `execute`, como el intermediario predeterminado de thirdweb (0xd04f98c88ce1054c90022ee34d566b9237a1203c).

## Permitir llamadas a Engine desde tu dominio (CORS)

1. Navega al [panel de control de Engine](https://thirdweb.com/team/~/~/engine) y selecciona tu instancia de Engine.
1. Dirígete a la sección de **Configuración**.
1. Bajo **Dominios permitidos**, ingresa el(los) dominio(s) de tu aplicación.
   - Incluye los entornos locales o de desarrollo para realizar pruebas.

<Callout variant='warning' title="El punto de enlace del relayer no está autenticado.">

Configura **Contratos Permitidos** y **Reenvíos Permitidos** para restringir las transacciones que tu relayer permite.

</Callout>

## Crear un relayer

1. Navega al [panel de control de Engine](https://thirdweb.com/team/~/~/engine) y selecciona tu instancia de Engine.
1. Dirígete a la sección de **Explorador**.
1. Selecciona **Agregar relayer**.
1. Proporciona los siguientes detalles:
   - **Cadena**: La cadena donde se llamarán los contratos.
   - **Billetera Backend**: La billetera backend que enviará las meta-transacciones al reenviador. Asegúrate de que esta billetera tenga fondos suficientes para gas.
   - **Etiqueta**: Un nombre descriptivo para este relayer.
   - **Contratos Permitidos**: (Opcional) Una lista de direcciones de contrato a las que este relayer tiene permitido enviar transacciones.
   - **Reenvíos Permitidos**: (Opcional) Una lista de direcciones de reenvío a las que este relayer tiene permitido enviar transacciones.

El relayer tendrá asignada una URL en este formato: `https://<engine_url>/relayer/<relayer_id>`

## Enviar una meta-transacción desde el frontend de tu aplicación

Usa el [Connect SDK](/react) para solicitar al usuario que firme transacciones y enviarlas a este relayer.

Primero, envuelve tu aplicación con `<ThirdwebProvider>`:

```tsx
import { ThirdwebProvider } from "thirdweb/react";

<ThirdwebProvider>
	<YourApp />
</ThirdwebProvider>;
```

Luego, solicita al usuario que conecte una billetera. Consulta [ConnectButton](https://portal.thirdweb.com/connect/sign-in/ConnectButton) para opciones de personalización.

```tsx
import { ConnectButton } from "thirdweb/react";

<ConnectButton client={client} />;
```

Este ejemplo llamará al método `claim` en un [contrato de NFT Drop](https://portal.thirdweb.com/contracts/explore/pre-built-contracts/nft-drop):

```solidity
function claim(address _receiver, uint256 _quantity, address _currency, uint256 _pricePerToken, AllowlistProof calldata _allowlistProof, bytes memory _data)
```

Renderiza un `<TransactionButton>` para preparar una transacción que será retransmitida a través de Engine.

```tsx
import { TransactionButton } from "thirdweb/react";

<TransactionButton
	transaction={() => {
		const contract = getContract({
			client,
			chain,
			address: NFT_ADDRESS,
		});

		return prepareContractCall({
			contract,
			method: resolveMethod("claim"),
			params: [
				// receiver
				account.address,
				// quantity
				1n,
				// currency
				NATIVE_TOKEN_ADDRESS,
				// pricePerToken
				0n,
				// allowlistProof
				{
					proof: [],
					quantityLimitPerWallet: 0n,
					pricePerToken: 0n,
					currency: NATIVE_TOKEN_ADDRESS,
				},
				// data
				"0x",
			],
		});
	}}
	onTransactionSent={(result) =>
		console.log("Submitted:", result.transactionHash)
	}
	onTransactionConfirmed={(receipt) =>
		console.log("Confirmed:", receipt.transactionHash)
	}
	onError={(error) => console.error("Error:", error)}
	gasless={{
		provider: "engine",
		relayerUrl: RELAYER_URL, // e.g. https://<engine_url>/relayer/<relayer_id>
		relayerForwarderAddress: FORWARDER_ADDRESS, // a trusted forwarder on the contract
	}}
>
	Claim
</TransactionButton>;
```

## Enviar una transacción meta desde el backend de tu aplicación (Avanzado)

Alternativamente, envía transacciones a tu relayer desde tu backend. Este enfoque te permite aplicar validaciones del lado del servidor o lógica de negocios antes de enviar la transacción para ser retransmitida.

1. Solicita al usuario que firme una transacción.
    - Este paso no requiere gas.
    - La firma debe coincidir con el formato que espera el forwarder.
2. Llama a tu backend con esta firma.
3. Llama a Engine desde tu backend: `POST https://<engine_url>/relayer/{relayer_id}`

    <Details id="relayer-body-payload" summary="Body payload">

        ```typescript
        {
        	type: "forward";
        	request: {
        		chainid?: string | undefined;
        		from: string;
        		to: string;
        		value: string;
        		gas: string;
        		nonce: string;
        		data: string;
        	};
        	signature: string;
        	forwarderAddress: string;
        } | {
        	type: "permit";
        	request: {
        		to: string;
        		owner: string;
        		spender: string;
        		value: string;
        		nonce: string;
        		deadline: string;
        	};
        	signature: string;
        } | {
        	type: "execute-meta-transaction";
        	request: {
        		from: string;
        		to: string;
        		data: string;
        	};
        	signature: string;
        }
        ```

     </Details>
