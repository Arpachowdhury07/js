import { Details, Callout, createMetadata } from "@doc";

export const metadata = createMetadata({
	title: "Contract Subscriptions | thirdweb Engine",
	description:
		"Subscribe to logs on any contract and query them from your app.",
});

# Suscripciones a Contratos

Recibe webhooks para cualquier registro de transacción o recibo de cualquier contrato.

Un **registro** es un evento emitido de una transacción ejecutada con éxito. Ejemplo: un NFT quemado emite un registro `Transfer OWNER -> 0x000...`.

Un **recibo** contiene detalles en la cadena para cualquier transacción. Esto puede ser útil para rastrear fallos en la cadena (ejecuciones revertidas).

## Casos de uso

Tu aplicación puede activar una acción cuando ocurra un evento en la cadena, como:

- Se transfiere ETH o una moneda ERC20 a o desde una billetera.
- Se acuña un token de tu colección de NFT.
- Un token en tu colección de NFT es quemado o transferido.
- Se actualizan los metadatos para un contrato oracle.

## Gestionar suscripciones a contratos

#### Agregar una suscripción a contrato

1. Navega al [panel de control de thirdweb engine](https://thirdweb.com/team/~/~/engine) y selecciona tu engine.
1. Selecciona **Suscripciones a Contratos**.
1. Selecciona **Agregar Suscripción a Contrato**.
1. Proporciona una URL de webhook.

Referencia de API: [`POST /contract-subscriptions/add`](https://thirdweb-engine.apidocumentation.com/reference#tag/contract-subscriptions/POST/contract-subscriptions/add)

#### Eliminar una suscripción a contrato

1. Navega al [panel de control de thirdweb engine](https://thirdweb.com/team/~/~/engine) y selecciona tu engine.
1. Selecciona **Suscripciones a Contratos**.
1. Selecciona **... > Eliminar** junto a una suscripción existente.

Referencia de API: [`POST /contract-subscriptions/remove`](https://thirdweb-engine.apidocumentation.com/reference#tag/contract-subscriptions/POST/contract-subscriptions/remove)

## Manejo de webhooks

Engine llamará a tu URL de webhook con los registros de eventos y los detalles de transacciones para el contrato(s) especificado.

#### Ejemplo de cuerpo del webhook

<Details id="sample-event-log" summary="Event log">
```json
{
  "type": "event-log",
  "data": {
    "chainId": 8453,
    "contractAddress": "0xcf205808ed36593aa40a44f10c7f7c2f67d4a4d4",
    "blockNumber": 14306496,
    "transactionHash": "0xdd73fc70754b6cb5238c33657b382e397aae635a8f9a3b26abe5f336059d0a40",
    "topics": [
      "0x2c76e7a47fd53e2854856ac3f0a5f3ee40d15cfaa82266357ea9779c486ab9c3"
    ],
    "data": "0x000000000000000000000000c60bf6eec03b33e1d02943348aaf8a5a3e6af4a80000000000000000000000004e5d89e10beafb7a49a03d136e7bb8e9519f4950000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000e35fa931a00000000000000000000000000000000000000000000000000000000b5e620f480000000000000000000000000000000000000000000000000000000b5e620f48000000000000000000000000000000000000000000000000000000000000000002",
    "eventName": "Trade",
    "decodedLog": {
      "isBuy": {
        "type": "bool",
        "value": "false"
      },
      "supply": {
        "type": "uint256",
        "value": "2"
      },
      "trader": {
        "type": "address",
        "value": "0xC60bf6EEc03B33E1D02943348AAf8A5a3E6Af4A8"
      },
      "subject": {
        "type": "address",
        "value": "0x4e5D89e10bEAfb7A49A03d136E7Bb8e9519f4950"
      },
      "ethAmount": {
        "type": "uint256",
        "value": "250000000000000"
      },
      "shareAmount": {
        "type": "uint256",
        "value": "1"
      },
      "subjectEthAmount": {
        "type": "uint256",
        "value": "12500000000000"
      },
      "protocolEthAmount": {
        "type": "uint256",
        "value": "12500000000000"
      }
    },
    "timestamp": 1715402339000,
    "transactionIndex": 33,
    "logIndex": 91
  }
}
```
</Details>

<Details id="sample-transaction-receipt" summary="Transaction receipt">

```json
{
	"type": "transaction-receipt",
	"data": {
		"chainId": 8453,
		"blockNumber": 14306498,
		"contractAddress": "0xcf205808ed36593aa40a44f10c7f7c2f67d4a4d4",
		"transactionHash": "0xa2cef7ca09ed9d6b6790fcb8556673e0c3e64ab5b2c127509469231454390e9e",
		"blockHash": "0x2302a36de3da9678638e577c35f66c766d5a011512f0644ab0c99a2018a8f2de",
		"timestamp": 1715402343000,
		"data": "0xb51d05340000000000000000000000005d5ecf22298e311815f92e0f5d41ae39148e9fc40000000000000000000000000000000000000000000000000000000000000001",
		"value": "0",
		"to": "0xcf205808ed36593aa40a44f10c7f7c2f67d4a4d4",
		"from": "0xc85077441915d1b0bd9bcf92cf03019710d317d9",
		"transactionIndex": 41,
		"gasUsed": "77523",
		"effectiveGasPrice": "31254333",
		"status": 1
	}
}
```

</Details>

#### Verificando las firmas de los webhooks

Consulta [Webhooks](/engine/features/webhooks) para obtener más información sobre cómo gestionar webhooks y verificar las firmas de los webhooks.

## Preguntas Frecuentes

#### ¿Cómo recibo múltiples webhooks para la misma dirección de contrato?

Agrega múltiples Suscripciones a Contratos con diferentes webhooks. Engine procesará los datos en la cadena una sola vez para evitar duplicar el trabajo.

#### ¿Puedo consultar datos a través de la API?

No, no es posible en este momento. Esta función está en la hoja de ruta futura.

#### ¿Las Suscripciones a Contratos recuperan datos pasados?

No, no es posible en este momento. Esta función está en la hoja de ruta futura.

#### ¿Por qué debería usar las Suscripciones a Contratos en lugar de consultar la blockchain directamente?

Consultar nodos RPC para obtener datos en la cadena es lento, poco confiable y costoso a gran escala. Los RPC tienen límites en el número de bloques que se pueden consultar a la vez. Incluso si tu contrato tiene baja actividad, tu aplicación debe consultar todos los bloques en el rango deseado para obtener resultados precisos.

Las Suscripciones a Contratos permiten que tu aplicación consulte los datos en la cadena que te interesan desde una base de datos, lo cual es más rápido, confiable y menos costoso.

#### ¿Cómo se diferencian las Suscripciones a Contratos de usar escuchadores de eventos con cualquier biblioteca web3?

Los escuchadores de eventos integrados en las bibliotecas web3 son apropiados para escuchar resultados en tiempo real sin ninguna persistencia o resiliencia. Si tu solicitud de backend se agota o tu backend tiene una caída, los datos del evento se pierden.

Una Suscripción a Contratos realiza una consulta continua a la blockchain para obtener registros y recibos desde el último bloque procesado y almacena los resultados en una base de datos. Tu aplicación puede depender de que los datos se almacenen eventualmente, incluso cuando ocurren problemas inesperados con tu backend, Engine, el RPC o la blockchain.
