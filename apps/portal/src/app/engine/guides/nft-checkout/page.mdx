import { DocImage } from "@doc";
import OverviewImage from "../../assets/nft-checkout-overview.png";
import NftCheckout1 from "../../assets/nft-checkout-1.png";
import NftCheckout2 from "../../assets/nft-checkout-2.png";
import NftCheckout3 from "../../assets/nft-checkout-3.png";
import { createMetadata } from "@doc";

export const metadata = createMetadata({
	title: "NFT Checkout | thirdweb Engine",
	description: "This guide uses thirdweb Engine to sell NFTs with credit card",
});

# Pago de NFT

Esta guía utiliza thirdweb Engine para vender NFTs con tarjeta de crédito:

1. Un comprador paga con tarjeta de crédito.
2. Al recibir el pago, tu backend llama a Engine.
3. Engine acuña un NFT en la billetera del comprador.

El comprador recibe el NFT sin necesidad de firmas de billetera o fondos para gas.

<DocImage src={OverviewImage} alt="NFT checkout overview" />

## Requisitos previos

- Un ID de cliente de thirdweb y una clave secreta desde tu página Equipo > Proyecto > Configuración.
- Una instancia de Engine.
- Una [billetera backend](/engine/features/backend-wallets) con fondos para pagar el gas.
- Un [token de acceso](/engine/features/authentication) para tu instancia de Engine.
- Un contrato NFT desplegado que pueda ser reclamado por la billetera backend.
- Una [cuenta de Stripe](https://dashboard.stripe.com/register) en modo de prueba (no se realizarán pagos reales).

## Frontend: Agregar el botón de Conectar Billetera y el formulario de tarjeta de crédito

Usa [`<ConnectWallet>`](/react/latest/components/ConnectWallet) para solicitar al comprador su dirección de billetera. El comprador proporciona los detalles de su tarjeta de crédito y selecciona **Pagar ahora** para enviar los detalles del pago directamente a Stripe.

```tsx
function Home() {
	return (
		<ThirdwebProvider activeChain="<chain_id>" clientId="<thirdweb_client_id>">
			<PurchasePage />
		</ThirdwebProvider>
	);
}
```

```tsx
// src/app/page.tsx
function PurchasePage() {
	const buyerWalletAddress = useAddress();
	const [clientSecret, setClientSecret] = useState("");

	// Retrieve a Stripe client secret to display the credit card form.
	const onClick = async () => {
		const resp = await fetch("/api/stripe-intent", {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify({ buyerWalletAddress }),
		});
		const json = await resp.json();
		setClientSecret(json.clientSecret);
	};

	const stripe = loadStripe("<stripe_publishable_key>");

	return (
		<main>
			<ConnectWallet />

			{!clientSecret ? (
				<button onClick={onClick}>Buy with credit card</button>
			) : (
				<Elements stripe={stripe} options={{ clientSecret }}>
					<CreditCardForm />
				</Elements>
			)}
		</main>
	);
}
```

```tsx
const CreditCardForm = () => {
	const elements = useElements();
	const stripe = useStripe();

	const onClick = async () => {
		// Submit payment to Stripe. The NFT is minted later in the webhook.
		await stripe.confirmPayment({
			elements,
			confirmParams: { return_url: "http://localhost:3000" },
			redirect: "if_required",
		});
		alert("Payment success. The NFT will be delivered to your wallet shortly.");
	};

	return (
		<>
			<PaymentElement />
			<button onClick={onClick}>Pay now</button>
		</>
	);
};
```

## Backend: Obtén un cliente secreto de Stripe

`POST /api/stripe-intent` devuelve un cliente secreto que es necesario para mostrar el formulario de tarjeta de crédito.

```tsx
// src/app/api/stripe-intent/route.ts

export async function POST(req: Request) {
	const { buyerWalletAddress } = await req.json();

	const stripe = new Stripe("<stripe_secret_key>", {
		apiVersion: "2023-10-16",
	});
	const paymentIntent = await stripe.paymentIntents.create({
		amount: 100_00,
		currency: "usd",
		payment_method_types: ["card"],
		// buyerWalletAddress is needed in the webhook.
		metadata: { buyerWalletAddress },
	});

	return NextResponse.json({
		clientSecret: paymentIntent.client_secret,
	});
}
```

## Backend: Configura el webhook de Stripe

`POST /api/stripe-webhook` llama a Engine para acuñar un NFT cuando se haya cobrado con éxito al comprador.

```tsx
// src/app/api/stripe-webhook/route.ts

export const config = {
	api: { bodyParser: false },
};

export async function POST(req: NextRequest) {
	// Validate the webhook signature
	// Source: https://stripe.com/docs/webhooks#secure-webhook
	const body = await req.text();
	const signature = headers().get("stripe-signature");
	const stripe = new Stripe("<stripe_secret_key>", {
		apiVersion: "2023-10-16",
	});

	// Validate and parse the payload.
	const event = stripe.webhooks.constructEvent(
		body,
		signature,
		"<webhook_secret_key>",
	);

	if (event.type === "charge.succeeded") {
		const { buyerWalletAddress } = event.data.object.metadata;

		// Mint an NFT to the buyer with Engine.
		const engine = new Engine({
			url: "<engine_url>",
			accessToken: "<engine_access_token>",
		});
		await engine.erc1155.mintTo(
			"<chain_id>",
			"<nft_contract_address>",
			"<backend_wallet_address>",
			{
				receiver: buyerWalletAddress,
				metadataWithSupply: {
					metadata: {
						name: "Engine Hackathon 2023",
						description: "Created with thirdweb Engine",
						image:
							"ipfs://QmakhKF5oMyxupCZ2RsmcvPRyYTHnQzYeb9mQGv3RM81n1/hat.webp",
					},
					supply: "1",
				},
			},
		);
	}

	return NextResponse.json({ message: "OK" });
}
```

## Configura los webhooks de Stripe

Navega al [tablero de webhooks de Stripe (modo de prueba)](https://dashboard.stripe.com/test/webhooks) y agrega el endpoint `/api/stripe-webhook` enviando el evento `charge.succeeded`.

## ¡Pruébalo!

Así es como se ve el flujo de usuario.

Se le pide al comprador que proporcione los detalles de su tarjeta de crédito.

<DocImage src={NftCheckout1} alt="Initial page load" className="w-[550px]" />

Ellos proporcionan los detalles de su tarjeta.

> _Consejo: El modo de prueba de Stripe acepta `4242 4242 4242 4242` como una tarjeta de crédito válida._

<DocImage
	src={NftCheckout2}
	alt="Prompted for card details"
	className="w-[550px]"
/>

Ellos son informados cuando su pago es procesado.

<DocImage src={NftCheckout3} alt="Pago exitoso" className="w-[550px]" />

## Ejemplo completo de código

El código anterior está simplificado para mejorar su legibilidad. [Ver el código fuente completo &rarr;](https://github.com/thirdweb-example/engine-nft-checkout)

## Preguntas frecuentes

### ¿Puedo aceptar diferentes métodos de pago?

¡Sí! Tú proporcionas el proveedor de pago y puedes aceptar diferentes monedas (EUR, JPY), billeteras digitales (Apple Pay, Google Pay), pagos bancarios (ACH, SEPA), métodos de pago locales (UPI, iDEAL) y más.

### ¿En qué se diferencia thirdweb NFT Checkout?

[thirdweb Checkout](https://thirdweb.com/checkout) es una solución completa que detecta fraudes, ofrece responsabilidad por contracargos, acepta múltiples métodos de pago incluyendo criptomonedas, incluye una experiencia de usuario preconstruida para el checkout, y más.
