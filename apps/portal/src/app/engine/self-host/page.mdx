import { Callout } from "@doc";

# Instrucciones para Hospedar por Tu Cuenta

Hospeda Engine en tu propia infraestructura de forma gratuita y administra tu instancia autohospedada desde el [dashboard de thirdweb](https://thirdweb.com/team/~/~/engine).

<Callout
	title="¿Quieres evitar configuración y mantenimiento?"
	variant="info"
>

[Obtén Engine alojado por thirdweb.](https://thirdweb.com/team/~/~/engine/create)

</Callout>

### Requisitos

- [Docker](https://docs.docker.com/get-docker/)
- Una clave secreta de thirdweb desde la página Team > Project > Settings.
- PostgresDB (versión 14+)
- Redis (versión 7.2.4+)

### Ejecutar Engine localmente

Inicia Postgres:

```bash
docker run -p 5432:5432 -e POSTGRES_PASSWORD=postgres -d postgres
```

Inicia Redis:

```bash
docker run -p 6379:6379 -d redis:7.2.4
```
Inicia el servidor de Engine:

```bash
docker run \
  -e ENCRYPTION_PASSWORD="<encryption_password>" \
  -e THIRDWEB_API_SECRET_KEY="<thirdweb_secret_key>" \
  -e ADMIN_WALLET_ADDRESS="<admin_wallet_address>" \
  -e POSTGRES_CONNECTION_URL="postgresql://postgres:postgres@host.docker.internal:5432/postgres?sslmode=disable" \
  -e ENABLE_HTTPS=true \
  -e REDIS_URL="redis://host.docker.internal:6379/0" \
  -p 3005:3005 \
  --pull=always \
  --cpus="0.5" \
  thirdweb/engine:latest
```

#### Variables de entorno

| Variable (<span style={{ color: "red" }}>\*</span> = Requerido) | Descripción                                                                                                                 |
| -------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------- |
| `ENCRYPTION_PASSWORD`<span style={{color:'red'}}>\*</span>     | Proporciona un string para cifrar datos sensibles almacenados en la base de datos. No cambies este valor o los datos cifrados serán inaccesibles. |
| `THIRDWEB_API_SECRET_KEY`<span style={{color:'red'}}>\*</span> | Una clave secreta de thirdweb creada al momento de la creación del proyecto (API Key).                                       |
| `ADMIN_WALLET_ADDRESS`<span style={{color:'red'}}>\*</span>    | La dirección de la billetera que configurará Engine desde el dashboard de thirdweb. Podrás añadir otros administradores más adelante. |
| `POSTGRES_CONNECTION_URL`<span style={{color:'red'}}>\*</span> | Cadena de conexión de Postgres: `postgresql://[user[:password]@][host][:port][/dbname][?param1=value1&...]`                  |
| `REDIS_URL`<span style={{color:'red'}}>\*</span>               | Cadena de conexión de Redis: `redis://[user:password@]host:port[/db-number]`                                                 |
| `ENABLE_HTTPS`                                                 | Firma automáticamente un certificado para servir solicitudes de API en HTTPS. Configúralo en `true` si ejecutas Engine localmente. (Por defecto: `false`) |
| `LOG_LEVEL`                                                    | Determina el nivel de severidad de los logs. Ajusta para mayor control sobre la información registrada. (Por defecto: `debug`)|
| `PRUNE_TRANSACTIONS`                                           | Cuando está en `false`, Engine evita la eliminación de datos de transacciones procesadas. (Por defecto: `true`)              |
| `ENABLE_KEYPAIR_AUTH`                                          | Habilita la [Autenticación por Par de Claves](/engine/features/keypair-authentication).                                       |
| `TRUST_PROXY`                                                  | Cuando está en `true`, confía en el encabezado `X-Forwarded-For` para permitir que Engine use la IP correcta del cliente en la lista de permitidos. |

<span style={{ color: "red" }}>*</span> Requerido

Tu servidor estará en funcionamiento cuando aparezca esta línea de registro:

```bash
Listening on https://localhost:3005. Manage your Engine from https://thirdweb.com/team/~/~/engine.
```

#### Administrar Engine desde el dashboard

Para administrar tu instancia de Engine desde el dashboard:

1. Navega a `https://localhost:3005/json`

   - Aparecerá la página "Tu conexión no es privada".
   - Selecciona **Opciones avanzadas** y luego **Proceder a localhost (no seguro)** para renderizar el archivo JSON.
   - _Este paso único permite que tu navegador se conecte a tu instancia local de Engine._

1. Navega a la [página del dashboard de Engine](https://thirdweb.com/team/~/~/engine).
1. Inicia sesión con la billetera `<admin_wallet_address>`.
1. Selecciona **Importar**.
1. Agrega la URL de tu instancia de Engine accesible públicamente.
   - Si Engine se está ejecutando localmente, proporciona la URL `https://localhost:3005`.

### Ejecutar Engine en producción

Consulta la [Lista de Verificación para Producción](/engine/production-checklist#cloud-hosting) para seguir las mejores prácticas al usar Engine en un entorno de producción.

- Fija la versión de Engine Docker para controlar cuándo se introducen cambios.
  - `latest` puede incluir cambios de versión mayor que pueden introducir cambios incompatibles.
- Hospeda la base de datos de Engine en cualquier [base de datos compatible con Postgres](https://www.postgresql.org/support/professional_hosting/).
  - Recuerda actualizar `POSTGRES_CONNECTION_URL`.
  - Ejemplos: [AWS RDS](https://aws.amazon.com/rds/postgresql/), [Google Cloud SQL](https://cloud.google.com/sql/docs/postgres), [Heroku](https://www.heroku.com/postgres), [Supabase](https://supabase.com/docs/guides/database/overview)
  - Especificaciones mínimas: 2 vCPU, 2 GB de memoria (equivalente a AWS t4g.small).
  - Versión mínima: 14.
  - Agrega el parámetro `?connection_limit=10` a tu `POSTGRES_CONNECTION_URL` para aumentar el límite de conexiones.
- Hospeda el servidor Engine en cualquier proveedor de nube.
  - Especificaciones mínimas: 1 vCPU, 2 GB de memoria (equivalente a AWS t2.small).
  - Autoescala la cantidad de instancias para aumentar la capacidad de cola y el flujo entrante.
- Elimina la variable de entorno `ENABLE_HTTPS`.

### Preguntas Frecuentes

#### ¿Por qué mi imagen Docker no puede conectarse a mi base de datos Postgres?

Aquí tienes algunos consejos comunes para solucionar problemas:

- Asegúrate de que la base de datos Postgres esté ejecutándose en Docker. `POSTGRES_CONNECTION_URL` debe configurarse como `localhost` (si está en el mismo contenedor) o `host.docker.internal` (si está en un contenedor diferente).
- Verifica que la URL de conexión y las credenciales de la base de datos Postgres sean correctas.
- Asegúrate de que el nombre de la base de datos exista en Postgres.

Consulta la [Lista de Verificación para Producción](/engine/production-checklist#cloud-hosting) para las mejores prácticas al usar Engine en un entorno de producción.

#### Recomendaciones para autohospedaje

- No configures la variable de entorno `ENABLE_HTTPS=true`.
- Hospeda Engine Docker en un proveedor de nube.
  - Especificaciones mínimas: 1 vCPU, 2 GB de memoria (equivalente a AWS t2.small).
  - Autoescala la cantidad de instancias para aumentar la capacidad de flujo entrante y cola.
- Hospeda la base de datos Postgres en un proveedor de nube.
  - Ejemplos: [AWS RDS](https://aws.amazon.com/rds/postgresql/), [Google Cloud SQL](https://cloud.google.com/sql/docs/postgres), [Heroku](https://www.heroku.com/postgres), [Supabase](https://supabase.com/docs/guides/database/overview)
  - Especificaciones mínimas: 2 vCPU, 2 GB de memoria (equivalente a AWS t4g.small).
  - Configura el parámetro `connection_limit` dentro de tu variable de entorno `POSTGRES_CONNECTION_URL` a `10`.

#### ¿Cómo filtrar los logs en Engine?

Configura la verbosidad de los logs mediante la variable de entorno `LOG_LEVEL`.
Los niveles de severidad, de mayor a menor, son:

- `fatal`: Termina el programa debido a errores críticos.
- `error`: Destaca problemas graves que necesitan acción inmediata.
- `warn`: Sugiere precaución debido a posibles problemas.
- `info`: Comparte información operativa rutinaria.
- `debug`: Proporciona información detallada para depuración.
- `trace`: Ofrece detalles exhaustivos de rastreo.

Por defecto, Engine captura logs de severidad `debug` y superiores. Configurar `LOG_LEVEL` como `error` limita los logs a severidades `error` y `fatal`.

```bash
LOG_LEVEL="error"
```

#### ¿Cómo prevenir errores `SIGSEGV` con la imagen Docker de Engine?

Garantiza la estabilidad de la imagen Docker de Engine asignando un mínimo de `0.5 vCPU y 1 GB de memoria` al contenedor, mitigando errores `SIGSEGV` (Fallo de Segmentación) debido a recursos insuficientes o problemas de acceso a la memoria.

#### ¿Cómo mitigar errores de Prisma relacionados con conexiones o transacciones?

Engine recomienda un límite mínimo de conexiones a la base de datos de `8` POR HOST. Configura el parámetro `connection_limit` dentro de tu variable de entorno `POSTGRES_CONNECTION_URL` para permitir un límite de conexión entre (8, número de conexiones soportadas por tu base de datos / número de hosts). En la práctica, un límite de conexión entre 10-20 es adecuado.

Error de base de datos:

```bash
Timed out fetching a new connection from the connection pool. More info: http://pris.ly/d/connection-pool (Current connection pool timeout: 10, connection limit: 3)
```

Configuración de ejemplo:

```bash
POSTGRES_CONNECTION_URL=postgres://postgres:postgres@localhost:5432/postgres?connection_limit=10
```

#### ¿Qué es `x-forwarded-for` y cómo afecta a Engine?

Si tienes Engine ejecutándose en un servidor detrás de un proxy inverso, puedes configurar la variable de entorno `TRUST_PROXY` como `true` para confiar en el encabezado `X-Forwarded-For`. Proxies inversos como Nginx o Apache añaden este encabezado a la solicitud con la dirección IP original del cliente. Configurar esta variable permitirá que Engine use la dirección IP correcta para la lista de permitidos (IP Allowlist). Para más detalles sobre la lista de permitidos por IP, consulta la página de [Características de Seguridad](/engine/features/security).
