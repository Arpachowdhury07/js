import { DocImage } from "@doc";
import multiwrapDiagramImage from "./assets/multiwrap-diagram.png";
import { createMetadata } from "@doc";

export const metadata = createMetadata({
	image: {
		title: "Documento de diseño de Multiwrap",
		icon: "contract",
	},
	title: "Documento de diseño de Multiwrap | thirdweb",
	description:
		"Este es un documento en vivo que explica qué es el contrato inteligente Multiwrap de thirdweb, cómo funciona, cómo puede ser utilizado y por qué está diseñado de la manera en que está.",
});

# Documento de diseño de Multiwrap.

Este es un documento en vivo que explica qué es el contrato inteligente `Multiwrap` de [thirdweb](https://thirdweb.com/), cómo funciona, cómo puede ser utilizado y por qué está diseñado de la manera en que está.

El documento está escrito para lectores tanto técnicos como no técnicos. Si tienes más preguntas sobre el contrato `Multiwrap` de thirdweb, por favor [visita nuestro sitio de soporte](https://thirdweb.com/support) o crea un issue en GitHub.

## Contexto

El contrato Multiwrap de thirdweb te permite agrupar tokens arbitrarios ERC20, ERC721 y ERC1155 que poseas en un único token agrupado / NFT.

El contrato `Multiwrap` está diseñado para agrupar múltiples activos (ERC20 / ERC721 / ERC1155) en un solo token agrupado, que luego puede ser desagrupado a cambio de los tokens subyacentes.

El único token agrupado recibido al agrupar múltiples activos, como se mencionó anteriormente, es un NFT ERC721. Este puede ser transferido, vendido en cualquier mercado de NFT y generar regalías como cualquier otro NFT.

### Cómo debería funcionar el producto `Multiwrap`

<DocImage src={multiwrapDiagramImage} alt="Diagrama de Multiwrap" />

El propietario de un token debería poder agrupar cualquier combinación de _n_ tokens ERC20, ERC721 o ERC1155 como un NFT agrupado. Al agrupar, el propietario del token debería poder especificar un destinatario para el NFT agrupado. En el momento de agrupar, el propietario del token debería poder establecer los metadatos del NFT agrupado que se acuñará.

El propietario del NFT agrupado debería poder desagrupar el NFT para recuperar los tokens subyacentes del NFT agrupado. En el momento de desagrupar, el propietario del NFT agrupado debería poder especificar un destinatario para los tokens subyacentes del NFT agrupado.

El creador del contrato `Multiwrap` debería poder aplicar las siguientes restricciones basadas en roles:

- Restringir qué activos se pueden agrupar en el contrato.
- Restringir qué carteras pueden agrupar tokens en el contrato.
- Restringir qué carteras pueden desagrupar NFTs agrupados que posean.

### Partes clave del producto `Multiwrap`

- Un propietario de un token debería poder agrupar cualquier combinación de _n_ tokens ERC20, ERC721 o ERC1155 como un token agrupado.
- Un propietario de un token agrupado debería poder desagrupar el token para recuperar los contenidos subyacentes del token agrupado.

### Por qué estamos construyendo `Multiwrap`

Estamos construyendo `Multiwrap` para casos donde una aplicación desea agrupar / distribuir / realizar transacciones sobre _n_ tokens independientes al mismo tiempo, como un único activo. Esto abre varios casos de uso novedosos para los NFTs.

Por ejemplo, considera un servicio de préstamos donde las personas pueden tomar un préstamo poniendo un NFT como garantía. Usando `Multiwrap`, un prestatario puede agrupar su NFT con algo de ether, y poner el NFT ERC721 agrupado resultante como garantía en el servicio de préstamos. Ahora, el NFT del prestatario, como garantía, tiene un valor mínimo.

## Detalles Técnicos

El contrato `Multiwrap` en sí es un contrato ERC721.

Permite agrupar tokens arbitrarios ERC20, ERC721 o ERC1155 que poseas en un único token agrupado / NFT. Esto significa embargar los tokens ERC20, ERC721 y ERC1155 relevantes en el contrato `Multiwrap`, y recibir el NFT agrupado a cambio.

Este NFT agrupado puede ser más tarde "desagrupado", es decir, quemado a cambio de los tokens subyacentes.

### Agrupar tokens

Para agrupar múltiples tokens ERC20, ERC721 o ERC1155 como un único NFT agrupado, un propietario de un token debe:

- aprobar los tokens relevantes para ser transferidos por el contrato `Multiwrap`.
- especificar los tokens a agrupar en un único NFT agrupado. El siguiente es el formato en el que cada token a agrupar debe ser especificado:

```solidity
/// @notice The type of assets that can be wrapped.
enum TokenType { ERC20, ERC721, ERC1155 }

struct Token {
    address assetContract;
    TokenType tokenType;
    uint256 tokenId;
    uint256 totalAmount;
}
```

| Parámetros    | Tipo      | Descripción                                                                          |
| ------------- | --------- | ------------------------------------------------------------------------------------ |
| assetContract | address   | La dirección del contrato del activo a agrupar.                                      |
| tokenType     | TokenType | El tipo de token (ERC20 / ERC721 / ERC1155) del activo a agrupar.                   |
| tokenId       | uint256   | El ID del token del activo a agrupar, si el activo es un NFT ERC721 / ERC1155.      |
| totalAmount   | uint256   | La cantidad del activo a agrupar, si el activo es un token fungible ERC20 / ERC1155. |

Cada token en el conjunto de tokens a agrupar como un único NFT agrupado debe ser especificado al contrato `Multiwrap` en forma de la estructura `Token`. El contrato maneja el token respectivo según el valor de `tokenType` proporcionado. Cualquier valor incorrecto pasado (por ejemplo, si la cantidad especificada para agrupar excede el saldo del token del propietario) causará que la transacción de agrupamiento se revierta.

Se pueden agrupar múltiples tokens como un solo NFT agrupado llamando a la siguiente función:

```solidity
function wrap(
    Token[] memory tokensToWrap,
    string calldata uriForWrappedToken,
    address recipient
) external payable returns (uint256 tokenId);
```

| Parámetros         | Tipo    | Descripción                            |
| ------------------ | ------- | -------------------------------------- |
| tokensToWrap       | Token[] | Los tokens a agrupar.                  |
| uriForWrappedToken | string  | La URI de metadatos para el NFT agrupado. |
| recipient          | address | El destinatario del NFT agrupado.     |

### Desagrupando el NFT agrupado

El único NFT agrupado, recibido al agrupar múltiples activos como se explicó en la sección anterior, puede ser desagrupado a cambio de los activos subyacentes.

Un NFT agrupado puede ser desagrupado por el propietario o una cartera aprobada por el propietario para transferir el NFT mediante las funciones `setApprovalForAll` o `approve` de ERC721.

Cuando se desagrupa el NFT agrupado, el NFT agrupado se quema.****

Un NFT agrupado puede ser desagrupado llamando a la siguiente función:

```solidity
function unwrap(
    uint256 tokenId,
    address recipient
) external;
```

| Parámetros | Tipo    | Descripción                                                                         |
| ---------- | ------- | ----------------------------------------------------------------------------------- |
| tokenId    | Token[] | El ID del token del NFT agrupado a desagrupar.                                       |
| recipient  | address | El destinatario de los tokens subyacentes ERC20, ERC721 o ERC1155 del NFT agrupado. |

## Permisos

| Nombre del rol | Tipo (Switch / !Switch) | Propósito                                                   |
| --------------- | ----------------------- | ----------------------------------------------------------- |
| TRANSFER_ROLE   | Switch                  | Solo se permiten transferencias de tokens hacia o desde los titulares del rol. |
| MINTER_ROLE     | Switch                  | Solo los titulares del rol pueden agrupar tokens.           |
| UNWRAP_ROLE     | Switch                  | Solo los titulares del rol pueden desagrupar NFTs agrupados.|
| ASSET_ROLE      | Switch                  | Solo los activos con el rol pueden ser agrupados.           |

¿Qué significa **Tipo (Switch / !Switch)**?

- **Switch:** Si `address(0)` tiene el `ROL`, entonces las restricciones del `ROL` no aplican.
- **!Switch:** Las restricciones del `ROL` siempre aplican.

## EIPs relevantes

| EIP  | Enlace                                    | Relación con `Multiwrap`                                                                                                                                     |
| ---- | ----------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 721  | https://eips.ethereum.org/EIPS/eip-721    | Multiwrap es un contrato ERC721. El NFT agrupado recibido por un propietario de token al agrupar es un NFT ERC721. Además, los tokens ERC721 pueden ser agrupados. |
| 20   | https://eips.ethereum.org/EIPS/eip-20     | Los tokens ERC20 pueden ser agrupados.                                                                                                                       |
| 1155 | https://eips.ethereum.org/EIPS/eip-1155   | Los tokens ERC1155 pueden ser agrupados.                                                                                                                     |
| 2981 | https://eips.ethereum.org/EIPS/eip-2981   | Multiwrap implementa ERC 2981 para distribuir regalías por ventas de los NFTs agrupados.                                                                     |
| 2771 | https://eips.ethereum.org/EIPS/eip-2771   | Multiwrap implementa ERC 2771 para soportar meta-transacciones (también llamadas transacciones “sin gas”).                                                     |
