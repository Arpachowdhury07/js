import SponsorshipRulesImg from "./sponsorship-rules.png";
import { Callout, DocImage, createMetadata } from "@doc";

export const metadata = createMetadata({
	image: {
		title: "Sponsorship rules",
		icon: "thirdweb",
	},
	title: "Sponsorship rules | thirdweb",
	description:
		"Set rules around which smart account transactions (User Ops) the paymaster should sponsor",
});

# Reglas de Patrocinio

Puedes definir fácilmente reglas sobre qué transacciones (Operaciones de Usuario) debe patrocinar el paymaster. Esto puede ser utilizado para prevenir abusos, incorporar usuarios progresivamente e incentivar acciones específicas dentro de la aplicación.

Puedes establecer las siguientes reglas de patrocinio:

- **Límites de gasto global**: Costo máximo de gas (en USD) que deseas patrocinar. Esto aplica durante la duración del período de facturación (mensual).
- **Verificador de servidor**: Esta es una verificación de propósito general que puede ser utilizada para definir reglas personalizadas. Antes de que una transacción sea enviada, se verifica con un endpoint que especificas si debe ser patrocinada o no.
- **Restricciones de dirección de contrato**: Usa esto si deseas patrocinar transacciones enviadas solo a un conjunto específico de contratos. Las transacciones enviadas a contratos fuera de esta lista de permitidos permanecerán sin patrocinio.
- **Restricciones de cadena**: Usa esto si deseas patrocinar transacciones solo en ciertas cadenas. Si esto no se configura, las transacciones en todas las [cadenas disponibles](https://portal.thirdweb.com/wallets/account-abstraction/infrastructure#supported-chains) serán patrocinadas.
- **Listas de usuarios**: Puedes usar esto para definir listas de permitidos o listas de bloqueados. Las listas de permitidos te permiten restringir las transacciones patrocinadas a transacciones enviadas por un conjunto específico de cuentas conocidas. Las listas de bloqueados te permiten bloquear a actores maliciosos de abusar de tu paymaster.
- **Cuentas de administrador**: Estas cuentas no están sujetas a ninguna regla de patrocinio, todas sus transacciones serán patrocinadas. Usa esto solo con cuentas que controlas (por ejemplo, para propósitos de prueba).

Recomendamos encarecidamente que establezcas reglas de patrocinio antes de que tu aplicación esté en vivo para prevenir que actores maliciosos abusen de tu paymaster, lo que podría llevar a facturas inesperadamente grandes.

### Configuración de Reglas de Patrocinio

Puedes establecer fácilmente reglas de patrocinio yendo a tu Equipo > Proyecto > Conectar > Abstracción de Cuentas > Página de Políticas de Patrocinio.

<DocImage src={SponsorshipRulesImg} />

### Configuración de un verificador de servidor

Puedes configurar un verificador de servidor proporcionando una URL que el paymaster llamará antes de patrocinar una transacción. Esto permite un control detallado sobre qué transacciones son patrocinadas.

La infraestructura de thirdweb enviará una solicitud POST a la URL que especifiques con la siguiente carga de datos JSON:


```ts
// thirdweb will call your server with the following JSON body as a POST request
{
	clientId: string; // the clientId that is making the request
	chainId: number; // the chainId of the transaction
	userOp: {
		sender: string; // the address of the sender
  		targets: string[]; // the addresses of the target contracts or wallets
  		gasLimit: string; // the gas limit of the transaction
  		gasPrice: string; // the gas price of the transaction in wei
                data: {
		  targets: string[], // the targets contracts or wallets called in this operation
		  callDatas: string[], // the call data of each transaction
		  values: string[], // the values (in wei) of each transaction
                }
	};
}
```

Tu servidor debe responder con un código 200 y la siguiente respuesta JSON:

```ts
// You should respond with the following JSON payload
{
	isAllowed: boolean; // whether the transaction should be sponsored or not
	reason: string?; // optional reason for why the transaction is not allowed
}
```

Nota: por razones de rendimiento, tu servidor debe responder dentro de los 5 segundos. Si tarda más, la transacción no estará patrocinada.

### Preguntas Frecuentes

**¿Qué sucede si se alcanza un límite? ¿La transacción falla o queda sin patrocinio?**

Si se alcanza un límite, la transacción quedará sin patrocinio. Si estás creando cuentas nuevas para los usuarios en tu aplicación, es poco probable que las cuentas de los usuarios tengan fondos. Puedes capturar el siguiente error de fondos insuficientes para manejar esto de manera elegante dentro de tu aplicación: `AA21 didn't pay prefund`.

**¿En qué redes están disponibles las reglas de patrocinio?**

Las reglas de patrocinio se aplican en todas las [redes en las que soportamos la abstracción de cuentas](https://portal.thirdweb.com/connect/account-abstraction/infrastructure#supported-chains). No necesitas especificar reglas diferentes para cada red o cada fábrica de cuentas, siempre y cuando usen el mismo ID de cliente.
Sin embargo, puedes restringir las transacciones patrocinadas a redes específicas si así lo deseas.

**¿Las reglas de patrocinio funcionarán con paymasters de terceros?**

No, las reglas de patrocinio se aplicarán si estás utilizando el paymaster de thirdweb.

### Precios

Configurar un verificador de servidor requiere que tu cuenta esté en el plan de crecimiento. Las otras políticas son gratuitas de usar. No hay precios basados en el uso para las políticas.
