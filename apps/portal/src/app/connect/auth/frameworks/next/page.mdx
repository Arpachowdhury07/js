import {
	OpenSourceCard,
	ArticleIconCard,
	Callout,
	Stack,
	createMetadata,
	InstallTabs,
	Tabs,
	TabsList,
	TabsContent,
	TabsTrigger,
} from "@doc";
import { GraduationCap } from "lucide-react";
import { V4SDKbanner } from "@/components/others/V4SDKBanner";

export const metadata = createMetadata({
	image: {
		title: "Integrate thirdweb Auth with Next.js",
		icon: "react",
	},
	title: "Auth in Next.js with thirdweb SDK",
	description: "Add support for Auth to your Next apps",
});

# Next.js

Si deseas interactuar con una versión funcional de la integración Auth + Next que estaremos construyendo en esta guía, puedes consultar el siguiente repositorio de GitHub o clonarlo con el siguiente comando:

```
npx thirdweb create app --template thirdweb-auth-next
```

<OpenSourceCard
	title="thirdweb-auth-next"
	href="https://github.com/thirdweb-example/thirdweb-auth-next"
	description="Auth Next example repository."
/>

## Instalación y Configuración

<InstallTabs
	npm="npm i thirdweb"
	yarn="yarn add thirdweb"
	pnpm="pnpm i thirdweb"
	bun="bun i thirdweb"
/>

Configura tu archivo `.env` con lo siguiente:

```bash
# el DOMINIO es el dominio de la aplicación
NEXT_PUBLIC_THIRDWEB_AUTH_DOMAIN=
# Obtén tu ID de cliente desde el panel de thirdweb: https://thirdweb.com/create-api-key
NEXT_PUBLIC_THIRDWEB_CLIENT_ID=
# Obtén tu clave secreta desde el panel de thirdweb: https://thirdweb.com/create-api-key
THIRDWEB_SECRET_KEY=
# Una clave privada que se usará para firmar el JWT para el método de autenticación `jwt-cookie`
# esto no necesita tener fondos, puede ser cualquier clave privada válida para firmar
AUTH_PRIVATE_KEY=
```

## Configuración del Lado del Cliente

Crea un directorio `lib` dentro de `src` y crea un archivo `client.ts` dentro de él:

```tsx
// lib/client.ts
import { createThirdwebClient } from "thirdweb";

const clientId = process.env.NEXT_PUBLIC_THIRDWEB_CLIENT_ID!; // this will be used on the client
const secretKey = process.env.THIRDWEB_SECRET_KEY!; // this will be used on the server-side

export const client = createThirdwebClient(
	secretKey ? { secretKey } : { clientId },
);
```

Agrega el `ThirdwebProvider` en tu layout raíz:

```tsx
// app/layout.tsx
import { ThirdwebProvider } from "thirdweb/react";

const Layout = ({ children }: { children: React.ReactNode }) => {
	return <ThirdwebProvider>{children}</ThirdwebProvider>;
};

export default Layout;
```

Hay dos formas de configurar Auth en el lado del cliente de una aplicación Next.js: el Botón de Conexión o tu propio componente personalizado. En ambos casos, usaremos un JWT en una cookie para almacenar la sesión del usuario y autenticarlo en toda la aplicación. El botón de conexión manejará gran parte de la complejidad subyacente por ti, pero si deseas utilizar tus propios componentes, las funciones que usa están expuestas para tu caso de uso personalizado.

<Tabs defaultValue="connect">

<TabsList>
	<TabsTrigger value="connect">Connect Button</TabsTrigger>
	<TabsTrigger value="custom">Custom Component</TabsTrigger>
</TabsList>

<TabsContent value="connect">
Donde quieras colocar tu botón de conexión, coloca el componente `ConnectButton`.

```tsx
// app/page.tsx
import type { NextPage } from "next";
import { ConnectButton } from "thirdweb/react";
import { client } from "@/lib/client";
import { generatePayload, isLoggedIn, login, logout } from "@/actions/login"; // we'll create this file in the next section

const Page = () => {
	return (
		<ConnectButton
			client={client}
			auth={{
				isLoggedIn: async (address) => {
					console.log("checking if logged in!", { address });
					return await isLoggedIn();
				},
				doLogin: async (params) => {
					console.log("logging in!");
					await login(params);
				},
				getLoginPayload: async ({ address }) => generatePayload({ address }),
				doLogout: async () => {
					console.log("logging out!");
					await logout();
				},
			}}
		/>
	);
};

export default Page;
```

Usa este componente en cualquier lugar de tu aplicación. Para probarlo, lo colocaremos en el archivo raíz `page.tsx`:

```tsx
// app/page.tsx
import ConnectButton from "@/components/ConnectButton";

const Home = () => {
	return <ConnectButton />;
};

export default Home;
```

</TabsContent>

<TabsContent value="custom">

In your project's components directory, create a `LoginButton.tsx` file:

```tsx
// LoginButton.tsx
"use client";

import { useActiveAccount, useActiveWalletChain } from "thirdweb/react";
import { generatePayload, login } from "@/actions/login"; // we'll add this file in the next section
import { signLoginPayload } from "thirdweb/auth";

export const LoginButton = () => {
	const account = useActiveAccount();
	const chain = useActiveWalletChain();
	const { connect, isConnecting, error } = useConnect();

	async function handleClick() {
		let activeAccount;
		if (!account) {
			const wallet = await connect(async () => {
				const wallet = createWallet("io.metamask"); // update this to your wallet of choice or create a custom UI to select wallets
				await wallet.connect();
				return wallet;
			});
			activeAccount = wallet.getAccount();
		} else {
			activeAccount = account;
		}
		// Step 1: fetch the payload from the server
		const payload = await generatePayload({
			address: account.address,
			chainId: chain.id,
		});
		// Step 2: Sign the payload
		const signatureResult = await signLoginPayload({ account, payload });
		// Step 3: Send the signature to the server for verification
		const finalResult = await login(signatureResult);

		alert(finalResult.valid ? "Login successful" : "Login failed");
	}

	return (
		<button disabled={!account} onClick={handleClick}>
			Login
		</button>
	);
};

export default LoginButton;
```

Use this component anywhere in your application. To try it out, we'll put it in the root `page.tsx`:

```tsx
// app/page.tsx
import LoginButton from "@/components/LoginButton";

const Home = () => {
	return <LoginButton />;
};

export default Home;
```

</TabsContent>

</Tabs>

## Configuración del Lado del Servidor

Usaremos funciones del servidor para mantener tu inicio de sesión seguro y conciso.

Crea un directorio `actions` con un archivo `login.ts` con lo siguiente:


```tsx
"use server";
import { VerifyLoginPayloadParams, createAuth } from "thirdweb/auth";
import { privateKeyToAccount } from "thirdweb/wallets";
import { client } from "@/lib/client";
import { cookies } from "next/headers";

const privateKey = process.env.AUTH_PRIVATE_KEY || "";

if (!privateKey) {
	throw new Error("Missing AUTH_PRIVATE_KEY in .env file.");
}

const thirdwebAuth = createAuth({
	domain: process.env.NEXT_PUBLIC_THIRDWEB_AUTH_DOMAIN || "",
	adminAccount: privateKeyToAccount({ client, privateKey }),
	client: client,
});

export const generatePayload = thirdwebAuth.generatePayload;

export async function login(payload: VerifyLoginPayloadParams) {
	const verifiedPayload = await thirdwebAuth.verifyPayload(payload);
	if (verifiedPayload.valid) {
		const jwt = await thirdwebAuth.generateJWT({
			payload: verifiedPayload.payload,
		});
		cookies().set("jwt", jwt);
	}
}

export async function isLoggedIn() {
	const jwt = cookies().get("jwt");
	if (!jwt?.value) {
		return false;
	}

	const authResult = await thirdwebAuth.verifyJWT({ jwt: jwt.value });
	return authResult.valid;
}

export async function logout() {
	cookies().delete("jwt");
}
```

Puedes incluir contexto personalizado en el token JWT con el parámetro `context`:

```ts
const jwt = await thirdwebAuth.generateJWT({
	payload: verifiedPayload.payload,
	context: {
		admin: true,
	},
});
```

Ahora, en cualquier lugar de tu proyecto, puedes verificar el estado de autenticación de un usuario:

```tsx
import { redirect } from "next/navigation";
import { isLoggedIn } from "../actions/login";

const AuthenticatedPage = async () => {
	// redirect back if user is not logged in
	if (!(await isLoggedIn())) {
		redirect("/connect-button");
	}

	return (
		<div>
			<h1>Logged In Page</h1>
			<p>You are logged in, so you can see this page!</p>
		</div>
	);
};

export default AuthenticatedPage;
```

¡Eso es todo! Ahora tienes una aplicación Next.js SIWE funcionando.

## Soporte

Para ayuda o comentarios, por favor [visita nuestro sitio de soporte](https://thirdweb.com/support)

