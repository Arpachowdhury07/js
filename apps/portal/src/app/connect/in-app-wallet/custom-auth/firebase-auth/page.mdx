import { Callout, DocImage, Steps, Step, createMetadata } from "@doc";
import ewCreateKey from "../images/ew-create-key.png";
import configurationView from "../images/configuration-view.png";
import customJsonFirebase from "../images/custom-json-firebase.png";

export const metadata = createMetadata({
	image: {
		title: "Integrar Firebase Auth para Billetera In-App",
		icon: "wallets",
	},
	title: "Integrar Firebase Auth | Billetera InApp",
	description:
		"Aprende cómo obtener un JSON Web Token (JWT) de Firebase usando el proveedor de email de Firebase e integrarlo con la Billetera In-App.",
});

# Integrar Firebase Auth

Aprende cómo obtener un JSON Web Token (JWT) de Firebase usando el proveedor de email de Firebase e integrarlo con la Billetera In-App.

<Callout title="Info" variant="info">

Este artículo cubre los pasos para integrar Firebase Auth en una aplicación React Native. Los pasos de Firebase y el código para la Billetera In-App pueden replicarse en React.

</Callout>

## Requisitos Previos

- Proyecto de Firebase
- Aplicación React

<Steps>

<Step title="Crear una Aplicación React Native">
Crea una aplicación React Native con la herramienta de tu elección e instala los paquetes necesarios:

```shell
npm i thirdweb
```

2. Ten en cuenta que asumimos que esta es una aplicación simple con una sola pantalla `App.tsx`.

</Step>

<Step title="Configura tu proyecto de Firebase">
	1. Configura un proyecto React Native Firebase siguiendo los [requisitos previos en la documentación de React Native Firebase](https://rnfirebase.io/#1-install-via-npm).
	2. Navega a la [Consola de Firebase](https://console.firebase.google.com/) y crea un nuevo proyecto.
	3. Navega a Autenticación > Método de inicio de sesión, para habilitar el [proveedor de Email/Contraseña](https://rnfirebase.io/auth/usage#emailpassword-sign-in).
</Step>

<Step title="Configura la URL de las claves JSON Web a través del dashboard">

1. Navega a Tu Equipo > Proyecto > Conectar > Billeteras In-App en el [dashboard de thirdweb](https://thirdweb.com/team)
2. Para usar billeteras In-App, elige un proyecto existente o crea uno nuevo.

   <DocImage src={ewCreateKey} />

3. En la vista de configuración, habilita **JSON Web Token Personalizado.**

   <DocImage src={configurationView} />

4. Establece la [URI de JWKS desde aquí](https://www.googleapis.com/service_accounts/v1/jwk/securetoken@system.gserviceaccount.com).

5. Establece el valor de AUD como el `projectId` de Firebase. (Ejemplo, `custom-auth-53169`)

   <DocImage src={customJsonFirebase} />

6. Selecciona **Guardar cambios**.

</Step>

<Step title="Añadir las dependencias de autenticación de Firebase">
Firebase auth depende de los paquetes `firebase/app` y `firebase/auth`.

Para agregar los paquetes, ejecuta el siguiente comando en el proyecto:

```bash
yarn add @react-native-firebase/app @react-native-firebase/auth
```

</Step>

<Step title="Implementar Autenticación por Email">
Añade el siguiente fragmento de código para manejar la autenticación por email con Firebase. Ten en cuenta que necesitas añadir una interfaz de usuario para permitir a los usuarios ingresar el email y la contraseña en tu archivo `App.tsx`:

Para manejar la autenticación por email con Firebase

```jsx
import auth from "@react-native-firebase/auth";

async function signInWithEmail(email, password) {
	try {
		await auth().createUserWithEmailAndPassword(email, password);
	} catch (error) {
		console.error(error);
	}
}

return (
	<Button title="Iniciar sesión" onPress={() => signInWithEmail(email, password)} />
);
```

Nota: Puedes añadir una interfaz de usuario para que los usuarios ingresen los campos de email y contraseña.

</Step>

<Step title="Obtener el JWT">
Una vez que el usuario está autenticado, puedes escuchar los [eventos de cambio de estado de autenticación (AuthStateChanged)](https://rnfirebase.io/auth/usage#listening-to-authentication-state) para obtener el usuario que inició sesión. Luego puedes obtener el JWT del objeto de usuario:

Para recibir el usuario que inició sesión, escucha el evento `AuthStateChanged`. Puedes agregar este código en tu archivo App.tsx también:

```jsx
const [user, setUser] = useState();

function onAuthStateChanged(user) {
	setUser(user);
}

useEffect(() => {
	// Escucha eventos de cambio de estado de autenticación
	const subscriber = auth().onAuthStateChanged(onAuthStateChanged);
	return subscriber;
}, [onAuthStateChanged]);

async function getFirebaseJWT() {
	if (user) {
		return await user.getIdToken();
	} else {
		throw new Error("El usuario no está autenticado");
	}
}
```

</Step>

<Step title="Pasar el JWT a InAppWallet">
Pasa el JWT a la configuración de la Billetera In-App en tu archivo `App.tsx`:

```jsx
import { inAppWallet } from "thirdweb/wallets";
import { useConnect } from "thirdweb/react";

const { connect } = useConnect();

const connectInApp = async (jwt: string) => {
	await connect(() => {
		const wallet = inAppWallet();
		wallet.connect({
			client,
			strategy: "jwt",
			jwt: await getFirebaseJWT(),
		});
		return wallet;
	});
};
```

Después de que la función `connectInApp` devuelva, el `ThirdwebProvider` habrá conectado una billetera, otorgando acceso a todos los hooks y funcionalidades.

</Step>

<Step title="Acceder a la cuenta conectada">
Para acceder a la cuenta conectada, usa el hook `useActiveAccount()`:

```jsx
import { useActiveAccount } from "thirdweb/react";

const activeWallet = useActiveAccount();
```

</Step>

</Steps>
