import { Callout, Steps, Step, DocImage, createMetadata } from "@doc";
import EWCustomAuth from "../images/customauth.png";
import EWCustomAuthdb from "../images/customauthdb.png";
import EWCustomAuthdb2 from "../images/customauthdb2.png";
import EWCreateKey from "../images/ew-create-key.png";
import EWConfig from "../images/ew-configuration.png";
import EWConfigOpt from "../images/ew-configuration-opt.png";
import EWJWKCreatorTool from "../images/jwk-creator-tool.png";

export const metadata = createMetadata({
	image: {
		title: "Crear un Servidor de Autenticación JWT Personalizado para Billetera In-App",
		icon: "wallets",
	},
	title: "Crear un Servidor de Autenticación JWT Personalizado | Billetera InApp",
	description:
		"Aprende cómo integrar tu backend de autenticación con nuestra solución de billeteras In-App para que puedas incorporar a tus usuarios a web3 sin problemas.",
});

# Crear un Servidor de Autenticación JWT Personalizado

Aprende cómo integrar tu backend de autenticación con nuestra solución de billeteras In-App para que puedas incorporar a tus usuarios a web3 sin problemas.

Esta guía te mostrará cómo crear tu propio servidor de autenticación que sea compatible con la estrategia de autenticación JWT. Al hacerlo, tendrás control total sobre la autenticación de usuarios y la seguridad de los datos. Esto te permitirá asegurarte de que tu aplicación cumpla con los requisitos específicos de cumplimiento y también proporcionar una experiencia de inicio de sesión personalizada.

<Callout title="Precaución" variant="danger">

Esta guía está simplificada para propósitos de demostración y no está lista para ser usada en producción. Al modificarla para producción, asegúrate de proteger tus endpoints y evitar codificar secretos o información sensible. Recomendamos usar variables de entorno y gestores de secretos.

</Callout>

<Steps>

<Step title="Configuración Inicial">
1. Crea un nuevo directorio para tu proyecto y navega a él en tu CLI

      ```bash
      mkdir jwt-auth-server
      cd jwt-auth-server
      ```

2. Inicializa una nueva aplicación de Node.js

   ```bash
   npm init -y
   yarn init -y
   ```

3. Instala los paquetes necesarios

   ```bash
   npm install express jsonwebtoken
   ```

</Step>

<Step title="Generar Par de Claves RSA">
1. Para generar una clave privada y una clave pública ejecuta

      ```bash
      ssh-keygen -t rsa -b 2048 -m PEM -f keys/rsa.key
      ```

2. Para crear el archivo de salida ejecuta

   ```bash
   openssl rsa -in keys/rsa.key -pubout -outform PEM -out keys/rsa.key.pub
   ```

</Step>

<Step title="Convertir Clave Pública a JSON Web Key Set (JWKS)">

1. Muestra la clave pública:

   ```bash
   cat keys/rsa.key.pub
   ```

2. Copia la clave pública mostrada.
3. Convierte tu clave pública a un JWK usando una herramienta en línea de creación de JWK. Recomendamos usar [JWK Creator por Russel Davies](https://github.com/russelldavies/jwk-creator).

   1. Pega la clave pública, establece el ID de la clave como `0` (una cadena arbitraria, debe coincidir al firmar el JWT), y luego anota el JWK generado.

   <DocImage src={EWJWKCreatorTool} />

4. Crea un archivo `jwks.json` en la raíz del proyecto y coloca el JWK generado en un array `keys`.

   ```bash
   {
     "keys": [
       {
          ... JWK ...
       }
     ]
   }
   ```

</Step>

<Step title="Crear el Servidor">

1. En el directorio `jwt-auth-server`, crea un archivo en la raíz llamado `server.js` y pega lo siguiente:

   ```jsx
   const express = require("express");
   const fs = require("fs");
   const jwt = require("jsonwebtoken");

   const app = express();
   const PORT = process.env.PORT || 3000;

   const PRIVATE_KEY = fs.readFileSync("./keys/rsa.key", "utf8");
   const jwks = require("./jwks.json");

   const users = [
   	{ id: 1, email: "user@example.com", password: "password123" },
   ];

   app.use(express.json());

   app.post("/login", (req, res) => {
   	const { email, password } = req.body;
   	const user = users.find(
   		(u) => u.email === email && u.password === password,
   	);
   	if (!user) return res.status(401).send({ message: "Credenciales inválidas" });

   	const payload = {
   		iss: "http://your-domain.com",
   		sub: user.id.toString(),
   		aud: "EpicGame",
   		email: user.email,
   		exp: Math.floor(Date.now() / 1000) + 3600,
   	};

   	const token = jwt.sign(payload, PRIVATE_KEY, {
   		algorithm: "RS256",
   		keyid: "0",
   	});

   	res.send({ token });
   });

   app.get("/.well-known/jwks.json", (req, res) => {
   	res.json(jwks);
   });

   app.listen(PORT, () => {
   	console.log(`Servidor iniciado en el puerto ${PORT}`);
   });
   ```

2. Reemplaza `http://your-domain.com` con el dominio real de la aplicación.

</Step>

<Step title="Probar Localmente">

1. Inicia el servidor:

   ```bash
   node server.js
   ```

2. Prueba el inicio de sesión:

   ```bash
   curl -X POST http://localhost:3000/login -H "Content-Type: application/json" -d '{"email": "user@example.com", "password": "password123"}'
   ```

3. Prueba JWKS:

   ```bash
   curl http://localhost:3000/.well-known/jwks.json
   ```

</Step>

<Step title="Desplegar">
Para desplegar el servidor, puedes usar servicios como [Zeet](https://zeet.co/) o [Docker](https://www.docker.com/).

Una vez desplegado, reemplaza `http://localhost:3000` en el payload del JWT con tu dominio real.

</Step>

<Step title="Integrar Billeteras In-App">

1. Navega a Team > Project > Connect > In-App Wallets en el [dashboard de thirdweb](https://thirdweb.com/team)
2. Crea una nueva clave API creando un proyecto si no tienes uno o selecciona uno existente para usarlo en este proyecto. [Aprende más sobre claves API.](/api-keys)

   <DocImage src={EWCreateKey} />

3. Lista blanca el dominio o los IDs del paquete en las restricciones de acceso.
4. Navega a la vista de Configuración y habilita **JSON Web Token Personalizado**

   <DocImage src={EWConfig} />

5. Establece la URI de JWKS en `your-domain/.well-known/jwks.json`
6. Establece el AUD en `EpicGame` o el valor que estableciste como `aud` en el archivo `server.js`.

   <DocImage src={EWConfigOpt} />

7. Copia el ID del cliente.
8. En tu SDK de cliente preferido de thirdweb, pasa el JWT que obtuviste al iniciar sesión en el servidor.

</Step>

</Steps>

Ahora se ha creado una billetera persistente y multiplataforma para tu usuario.
