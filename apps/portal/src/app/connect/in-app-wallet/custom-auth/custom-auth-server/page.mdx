import {
	Tabs,
	TabsList,
	TabsTrigger,
	TabsContent,
	Steps,
	Step,
	DocImage,
	Callout,
	createMetadata,
} from "@doc";
import EWCreateKey from "../images/ew-create-key.png";
import EWCustomAuthConfig from "../images/ew-custom-auth-config.png";
import EWCustomAuthFlow from "../images/ew-custom-auth-flow.png";
import EWJWKCreatorTool from "../images/jwk-creator-tool.png";

export const metadata = createMetadata({
	image: {
		title: "Servidor de Autenticación Personalizada para Billetera In-App",
		icon: "wallets",
	},
	title: "Servidor de Autenticación Personalizada | Billetera InApp",
	description:
		"Aprende cómo integrar tu backend de autenticación con nuestra solución de billeteras In-App para que puedas incorporar a tus usuarios a web3 sin problemas.",
});

# Servidor de Autenticación Personalizada

Aprende cómo integrar tu backend de autenticación con nuestra solución de billeteras In-App para que puedas incorporar a tus usuarios a web3 sin problemas.

Esta guía te mostrará cómo crear tu propio servidor de autenticación que sea compatible con la estrategia `auth_endpoint`. Al hacerlo, tendrás control total sobre la autenticación de usuarios y la seguridad de los datos. Esto te permitirá asegurarte de que tu aplicación cumpla con los requisitos específicos de cumplimiento y también proporcionar una experiencia de inicio de sesión personalizada.

<Callout variant="warning" title="Seguridad">
	Esta guía está simplificada para propósitos de demostración y no está lista para ser usada en producción. Al modificarla para producción, asegúrate de proteger tus endpoints y evitar codificar secretos o información sensible. Recomendamos usar variables de entorno y gestores de secretos.
</Callout>

## Guía rápida de 5 minutos

<Steps>

<Step>
	Navega a Tu Equipo > Proyecto > Conectar > Página de Billeteras In-App desde el (dashboard)[https://thirdweb.com/team]
</Step>

<Step>
	Crea una clave API de thirdweb si no tienes una o selecciona una clave existente para usarla en este proyecto. [Aprende más sobre claves API.](/api-keys)

<DocImage src={EWCreateKey} />

</Step>

<Step>
	Lista blanca el dominio o los IDs del paquete en las restricciones de acceso.
</Step>

<Step>
	Navega a la vista de Configuración y habilita **Endpoint de Autenticación Personalizada**

    <DocImage src={EWCustomAuthConfig} />

</Step>

<Step>
	Establece la URL del Endpoint de Autenticación en
	`https://embedded-wallet.thirdweb.com/api/2023-11-30/embedded-wallet/auth/test-custom-auth-endpoint`
	para propósitos de prueba. Luego reemplazarás esto con tu propio endpoint del servidor de autenticación para verificar el `payload`.
</Step>

<Step>Guarda la configuración.</Step>

<Step>Copia el ID del cliente.</Step>

<Step>
	En tu SDK de cliente preferido de thirdweb, pasa el payload que obtuviste al iniciar sesión en el servidor.
</Step>

</Steps>

Ahora puedes autenticarte en la billetera y usarla para firmar transacciones como se muestra a continuación (consulta [usa tu propia autenticación para más](/in-app-wallet/custom-auth)):

<Tabs defaultValue="react">
<TabsList>
	<TabsTrigger value="react">React & React Native</TabsTrigger>
	<TabsTrigger value="typescript">Otros Frameworks</TabsTrigger>
</TabsList>

<TabsContent value="react">

```typescript
import { inAppWallet } from "thirdweb/wallets";
import { useConnect } from "thirdweb/react";

const { connect } = useConnect();

const handlePostLogin = async (jwt: string) => {
	await connect(() => {
		const wallet = inAppWallet();
		wallet.connect({
			client,
			strategy: "auth_endpoint",
			payload: JSON.stringify({ userId: "ANY_RANDOM_ID_HERE" }),
		});
		return wallet;
	});
};
```

</TabsContent>

<TabsContent value="typescript">

```typescript
import { inAppWallet } from "thirdweb/wallets";

const wallet = inAppWallet();

const account = await wallet.connect({
	client,
	strategy: "auth_endpoint",
	payload: JSON.stringify({ userId: "ANY_RANDOM_ID_HERE" }),
});

// usa la cuenta para enviar transacciones
```

</TabsContent>
</Tabs>

Ahora se ha creado una billetera persistente y multiplataforma para tu usuario.

Por supuesto, usarías tu propio servidor de autenticación en lugar del que proporcionamos. El resto de esta guía te mostrará cómo crear tu propio servidor de autenticación.

### Configuración

Los siguientes pasos te mostrarán cómo crear un servidor de autenticación simple que se pueda usar con la billetera embebida.

A grandes rasgos, el servidor de autenticación hará lo siguiente:

1. Manejar el inicio de sesión del usuario en tu aplicación.
2. Tener una forma de obtener un identificador público para el usuario.
3. Tener un endpoint para verificar el identificador público y devolver información básica sobre el usuario.

Los pasos 1 y 2 dependen de ti para implementarlos. Puedes usar cualquier estrategia de autenticación que desees.

El endpoint en el paso 3 es lo que registras como tu endpoint de autenticación en el dashboard de thirdweb.

Aquí tienes un diagrama a alto nivel:

<DocImage src={EWCustomAuthFlow} />

<Steps>

<Step>

Crea un nuevo directorio para tu proyecto y navega a él en tu CLI

```bash
mkdir custom-auth-server
cd custom-auth-server
```

</Step>

<Step>

Inicializa una nueva aplicación de Node.js

```bash
npm init -y
```

O

```bash
yarn init -y
```

</Step>

</Steps>

### **Crear el Servidor:**

En el directorio `custom-auth-server`, crea un archivo en la raíz llamado `server.js` y pega lo siguiente:

```jsx
const express = require("express");
const fs = require("fs");

const app = express();
const PORT = process.env.PORT || 3000;

const users = [{ id: 1, email: "user@example.com", password: "password123" }];

app.use(express.json());

// Esto es lo que tu aplicación llama para iniciar sesión de un usuario y obtener un identificador público para el usuario (tambien conocido como el payload)
app.post("/login", (req, res) => {
	const { email, password } = req.body;
	const user = users.find((u) => u.email === email && u.password === password);
	if (!user) return res.status(401).send({ message: "Credenciales inválidas" });

	res.send({ payload: user.id });
});

// Este es un endpoint de ejemplo que registrarías en el dashboard de thirdweb para que verifiquemos el payload
app.post("/thirdweb-will-call-this", (req, res) => {
	const { payload } = req.body;
	if (!payload) return res.status(401).send({ message: "Credenciales inválidas" });

	// Aquí escribirías tu propia lógica para verificar el payload
	const user = users.find((u) => u.id === payload);
	if (!user) return res.status(401).send({ message: "Credenciales inválidas" });

	// Una vez que el usuario es verificado con éxito, puedes devolver el siguiente campo
	return res.send({
		userId: user.id,
		// Los dos últimos campos aquí son opcionales
		email: user.email,
		exp: Math.floor(Date.now() / 1000) + 60 * 60 * 24 * 30,
	});
});

app.listen(PORT, () => {
	console.log(`Servidor iniciado en el puerto ${PORT}`);
});
```

### **Probar Localmente**

1. Inicia el servidor:

   ```bash
   node server.js
   ```

2. Prueba el inicio de sesión:

   ```bash
   curl -X POST http://localhost:3000/login -H "Content-Type: application/json" -d '{"email": "user@example.com", "password": "password123"}'
   ```

### **Desplegar**

Para desplegar el servidor, puedes usar servicios como [Zeet](https://zeet.co/) o [Docker](https://www.docker.com/).

### **Integrar Billeteras In-App**

Consulta la [guía rápida arriba](#guía-rápida-de-5-minutos) para integrar la billetera embebida en tu aplicación.
