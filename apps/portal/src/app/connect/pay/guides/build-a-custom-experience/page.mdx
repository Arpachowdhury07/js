import {
	createMetadata,
	Callout,
	DocImage,
	InstallTabs,
	Steps,
	Step,
} from "@doc";
import OnrampStepOne from "../../assets/avax-to-usd.png";

export const metadata = createMetadata({
	image: {
		title: "thirdweb Pay - Custom Experience",
		icon: "thirdweb",
	},
	title: "thirdweb Pay - Buy With Fiat - Custom Experience | thirdweb",
	description:
		"Learn how to build a custom onramp experience with thirdweb Pay.",
});

# Construye una Experiencia Personalizada con Fiat

Aprende cómo habilitar a tus usuarios para que compren el token de tu aplicación con cualquier método de pago fiat utilizando nuestro flujo headless.

En esta guía, te mostraremos cómo comprar 0.01 Base ETH desde USD en TypeScript.

<Callout variant="info">
	El componente `PayEmbed` maneja la complejidad del proceso detallado a continuación
	y puede integrarse en minutos. Te recomendamos consultar la [guía de PayEmbed
	aquí](/connect/pay/get-started#option-2-embed-pay).
</Callout>


---

<Steps>
<Step title='Instalar el SDK de Connect'>
<InstallTabs
	npm="npm i thirdweb"
	yarn="yarn install thirdweb"
	pnpm="pnpm i thirdweb"
/>
<Step title='Obtener tu Client ID'>

Inicia sesión en el [dashboard de thirdweb](https://thirdweb.com/team). Haz clic en Crear Nuevo > Proyecto para obtener tu **Client ID**. Necesitarás tu Client ID para interactuar con el SDK de Connect.

</Step>
</Step>
<Step title='Obtener una cotización de “Comprar con Fiat”'>
Comprar con fiat puede requerir uno o dos pasos dependiendo del token de destino:

Si el token de destino _*puede*_ comprarse directamente con fiat, los usuarios pueden hacer onramp directamente hacia su token de destino.

Si el token de destino _*no puede*_ comprarse directamente con fiat, los usuarios deberán hacer onramp a un token intermedio y luego convertir este token al token de destino.

Por ejemplo, al comprar Base ETH:

1. Los usuarios recibirán Avalanche AVAX (token nativo) a cambio de USD.
2. Luego, se les pedirá que conviertan Avalanche AVAX a Base ETH.

<DocImage src={OnrampStepOne} />

Este proceso requiere la dirección de la billetera de tus usuarios. Consulta [esta guía](https://portal.thirdweb.com/typescript/v5/connecting-wallets) para aprender cómo conectar una billetera.

```tsx
import { getBuyWithFiatQuote } from "thirdweb/pay";
import { NATIVE_TOKEN_ADDRESS } from "thirdweb";
import { base } from "thirdweb/chains";

// create a thirdweb client
const client = createThirdwebClient({
	clientId: "<your_client_id>",
});

// Get a quote for buying 0.01 Base ETH with USD
const quote = await getBuyWithFiatQuote({
	client: client, // thirdweb client
	fromCurrencySymbol: "USD", // fiat currency symbol
	toChainId: base.id, // base chain id
	toAmount: "0.01", // amount of token to buy
	toTokenAddress: NATIVE_TOKEN_ADDRESS, // native token
	toAddress: "0x...", // user's wallet address
});

// display quote information to user
console.log(quote.fromCurrencyWithFees);
console.log(quote.processingFees);
console.log(quote.onRampToken);
console.log(quote.toToken);
console.log(quote.estimatedDurationSeconds);
// etc...
```

El objeto `quote` contiene información detallada sobre la transacción, incluyendo el tiempo estimado, las tarifas de procesamiento, la cantidad de moneda fiduciaria requerida y más, que puedes mostrar en tu aplicación.

</Step>
<Step title='Verificar el paso de compra con cripto'>
El objeto `quote` contiene los objetos `quote.onRampToken` y `quote.toToken`, que contienen la información sobre los tokens intermedios y de destino.

Si `quote.onRampToken` no es el mismo que `quote.toToken`, entonces tus usuarios necesitarán hacer un onramp al token intermedio antes de llegar al token de destino.

Puedes usar `isSwapRequiredPostOnramp` para verificar esto.


```tsx
import { isSwapRequiredPostOnramp } from "thirdweb/pay";

const hasTwoSteps = isSwapRequiredPostOnramp(quote);

if (hasTwoSteps) {
	// display the two steps to the user
}
```

</Step>
<Step title='Mostrar la Experiencia de Onramp'>
Una vez que tengas una `quote` de `getBuyWithFiatQuote`, puedes abrir una nueva pestaña con `quote.onRampLink` para mostrar la experiencia de onboarding. Esta experiencia de onboarding maneja todos los requisitos regulatorios, verificaciones de conocimiento del cliente (KYC) y la revisión de sanciones.

Después de que se haya completado el proceso de KYC (si es necesario), los clientes tendrán la opción de guardar los métodos de pago, los datos de KYC y la información de la billetera en el onboarding, lo que hace que la experiencia de onboarding en futuras visitas sea mucho más rápida.

Tus usuarios podrán comprar el `quote.onRampToken` con la moneda fiduciaria especificada.

```ts
window.open(quote.onRampLink, "_blank");
```

</Step>
<Step title='Consultar el Estado de la Transacción'>
Cuando abras el `quote.onRampLink` en una nueva pestaña, puedes comenzar a consultar el estado de la transacción de onboarding en tu aplicación llamando a `getBuyWithFiatStatus`.

`getBuyWithFiatStatus` requiere un `intentId` que puedes obtener del objeto `quote`.

Existen varios estados de transacción:


```tsx
// Sigue llamando al código a intervalos regulares para consultar el estado

const fiatStatus = await getBuyWithFiatStatus({
	client: client, // cliente de thirdweb
	intentId: quote.intentId, // pasa el intentId desde quote
});

if (fiatStatus.status === "NOT_FOUND") {
	// intentId no válido
	// Muestra un error en tu página
}

if (fiatStatus.status === "NONE") {
	// No hay información disponible aún
	// Muestra un estado "cargando" en tu página
	// sigue consultando
}

if (fiatStatus.status === "PENDING_PAYMENT") {
	// El pago está en proceso en el proveedor de la plataforma de pago
	// Muestra un estado "cargando" en tu página
	// sigue consultando
}

if (fiatStatus.status === "PENDING_ON_RAMP_TRANSFER") {
	// El pago se realizó, el proceso de la plataforma de pago no ha comenzado
	// Muestra un estado "cargando" en tu página
	// sigue consultando
}

if (fiatStatus.status === "ON_RAMP_TRANSFER_IN_PROGRESS") {
	// El proveedor de la plataforma de pago está haciendo el proceso de transferencia con la moneda fiat
	// Muestra un estado "cargando" en tu página
	// sigue consultando
}

if (fiatStatus.status === "ON_RAMP_TRANSFER_FAILED") {
	// El proveedor de la plataforma de pago falló en hacer el proceso de transferencia
	// Muestra un error en tu UI
	// DEJA DE consultar
}

if (fiatStatus.status === "ON_RAMP_TRANSFER_COMPLETED") {
	// Si solo es necesario el proceso de la plataforma de pago - ¡el proceso está completo!
	if (!hasTwoSteps) {
		// Muestra "éxito"
		// Deja de consultar
		// ¡Eso es todo!
	} else {
		// Espera el estado "CRYPTO_SWAP_REQUIRED" para convertir los tokens
		// Muestra un estado "cargando" en tu página
		// Deja de consultar
	}
}

if (fiatStatus.status === "CRYPTO_SWAP_REQUIRED") {
	// Ve al paso 5
	// Muestra la interfaz de usuario para la cotización de compra con criptomonedas desde `quote.onRampToken` a `quote.toToken`
	// Deja de consultar
}
```

</Step>
<Step title='Obtener una Cotización de Compra con Criptomonedas (Opcional)'>
Este paso solo es relevante cuando se requiere una compra de criptomonedas a criptomonedas después de realizar un proceso de onramp a un token intermedio.

En este caso, puedes usar `getPostOnRampQuote` para obtener una cotización para convertir el token intermedio al token de destino.

```tsx
// when fiatStatus.status === "CRYPTO_SWAP_REQUIRED"
// and hasTwoStep === true

const swapQuote = await getPostOnRampQuote({
	client: client,
	buyWithFiatStatus: fiatStatus,
});

if (!swapQuote) {
	// invalid fiatStatus status
} else {
	// Go to step 6 to kick off the "Swap" flow
}
```

</Step>
<Step title='Ejecutar Compra con Criptomonedas'>
Ejecutar la Compra con Criptomonedas puede implicar un solo paso o dos pasos.

Si tu token de origen es un token ERC-20, se requiere un paso de aprobación antes de ejecutar la transacción de Compra con Criptomonedas.

Puedes verificar si se requiere aprobación comprobando `quote.approval`.


```tsx
import { sendTransaction, waitForReceipt } from "thirdweb";

const account = wallet.getAccount();

// Si se requiere aprobación, enviar la transacción de aprobación
// mostrar un botón al usuario para solicitar la aprobación y enviar la transacción al hacer clic
if (quote.approval) {
	// solicitar permisos para gastar tokens del monedero
	const approveTxResult = await sendTransaction({
		transaction: quote.approval, // transacción de aprobación
		account: account, // cuenta del monedero conectado por el usuario
	});

	await waitForReceipt(approveTxResult);
}

// El paso anterior puede generar un error si el usuario rechaza o la transacción falla
// Si da error, debe realizarse nuevamente hasta que sea exitosa

// Una vez que la aprobación se haya completado, puedes enviar la transacción buyWithCrypto
// mostrar un botón al usuario para solicitar el envío de la transacción buyWithCrypto y enviarla al hacer clic
const buyWithCryptoTxResult = await sendTransaction({
	transaction: quote.transactionRequest,
	account: account,
});

await waitForReceipt(buyWithCryptoTxResult);

// Guardar el hash de la transacción de compra con criptomonedas para realizar el seguimiento del estado como se menciona en el paso 7
const buyWithCryptoTxHash = buyWithCryptoTxResult.transactionHash;

```

</Step>
<Step title='Realizar seguimiento del estado de la compra con criptomonedas'>
Una vez que hayas iniciado la transacción de compra con criptomonedas, querrás realizar un seguimiento del estado. Puedes notificar a los usuarios a lo largo de este proceso verificando los siguientes estados:

```tsx
import { getBuyWithCryptoStatus } from 'thirdweb/pay'

// Continúa llamando al siguiente código a intervalos regulares si el estado está en una fase pendiente

const swapStatus = await getBuyWithCryptoStatus({
   client: client,
   transactionHash: swapTxHash,
}});

if (swapStatus.status === "NOT_FOUND") {
  // transacción de intercambio inválida
  // Muestra un error en tu página
  // Detén el seguimiento
}

if (swapStatus.status === "NONE") {
  // Aún no hay información disponible
  // Muestra "cargando" en la interfaz de usuario
  // Continúa el seguimiento
}

if (swapStatus.status === "FAILED") {
  // El intercambio falló
  // Muestra "error" en la interfaz de usuario y ofrece una opción de reintento
  // Detén el seguimiento
}

if (swapStatus.status === "COMPLETED") {
  // El intercambio se completó
  // Muestra "éxito" en la interfaz de usuario
  // Detén el seguimiento
}

if (swapStatus.status === "PENDING") {
  // El intercambio está en progreso
  // Muestra "cargando" en la interfaz de usuario
  // Continúa el seguimiento
}
```

</Step>
</Steps>

---

### Crear una experiencia personalizada en React

Si estás utilizando React, ofrecemos Hooks para cada una de las funciones mencionadas anteriormente:

| React Hook           | Typescript           |
| :------------------- | :------------------- |
| useBuyWithFiatQuote  | getBuyWithFiatQuote  |
| usePostOnrampQuote   | getPostOnrampQuote   |
| useBuyWithFiatStatus | getBuyWithFiatStatus |
