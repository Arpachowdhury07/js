import { createMetadata, Callout, DocImage, Steps, Step } from "@doc";
import DirectPaymentsFlow from "../../assets/direct-payments-flow.png";

export const metadata = createMetadata({
	image: {
		title: "thirdweb Pay - Accept Direct Payments",
		icon: "thirdweb",
	},
	title: "thirdweb Pay - Accept Direct Payments | thirdweb",
	description:
		"Combine Pay and Engine to create a smooth point of sale experience on any chain",
});

# Aceptar Pagos Directos con Pay & Engine

Aprende cómo aceptar pagos en fiat y criptomonedas de tus clientes utilizando Pay y cómo activar acciones de Engine, como acuñar NFTs o transferir tokens a las billeteras de los usuarios.

### Requisitos

- [Un ID de Cliente de thirdweb](https://portal.thirdweb.com/typescript/v5/client)
- [Una instancia de Engine](https://thirdweb.com/team/~/~/engine)

### Descripción General del Flujo de Compra

Antes de comenzar, es importante entender el sistema completo, desde la compra inicial hasta la transferencia final de activos. Este proceso consta de cuatro pasos (con un quinto opcional):

<DocImage src={DirectPaymentsFlow} />

1. **El usuario inicia la compra:** El usuario envía los fondos especificados (ETH, MATIC, USD, etc.) a tu billetera a través de thirdweb Pay.
   - Tu billetera puede ser cualquier billetera comercial que elijas o la billetera backend de Engine.
   - Usa el campo `purchaseData` para pasar cualquier dato del artículo necesario en el webhook.
     Por ejemplo: `{ nftId: 1 }`.
2. **Pay procesa la compra:** thirdweb Pay procesa la transacción y envía un [webhook de Compra Completa](/connect/pay/webhooks#purchase-complete) al servidor de tu dapp cuando la transacción se completa.
3. **Tu servidor llama a Engine:** Tu servidor procesa el webhook y envía una llamada al contrato al backend de thirdweb Engine para realizar la compra del artículo.
4. **Engine ejecuta la transacción:** La billetera backend de Engine ejecuta la transacción necesaria para entregar el(los) token(s) a la dirección del usuario.
5. **(Opcional) El usuario es notificado:** Tu servidor confirma la transacción completada en Engine y notifica al usuario.

Ahora, comencemos.

<Steps>
	<Step title="Configurar thirdweb Engine">

1. Si aún no lo has hecho, inicia sesión y [despliega una instancia de Engine](https://thirdweb.com/team/~/~/engine).

2. Crea o importa una billetera backend para Engine en [tu panel de Engine](https://thirdweb.com/team/~/~/engine).

3. Envía los fondos necesarios a la billetera backend:
   - Por ejemplo, si la compra se realiza con Arb Nova USDC, tu billetera backend debe contener este token ERC20.
   - Si tu billetera backend tiene un token ERC20, asegúrate de agregar un saldo de tokens nativos para cubrir los costos de gas. Por ejemplo, para una transacción en Arbitrum Nova, tu billetera backend debe contener tanto Arb Nova USDC (para el pago) como Arb Nova ETH (para el gas).
   - Tu billetera backend debe contener suficiente liquidez para manejar cualquier volumen de compra anticipado.

4. Haz un plan para monitorear y mantener la billetera flotante con fondos suficientes para evitar problemas con el servicio.
</Step>

   <Step title="Integrar thirdweb Pay (Cliente)">

1. [Integra thirdweb Pay](https://portal.thirdweb.com/connect/pay/build-a-custom-experience) en el lado del cliente para habilitar pagos con fiat y criptomonedas.

2. Especifica los parámetros requeridos para tu transacción con Pay.

    		```ts
    		const quote = await getBuyWithFiatQuote({
    			client: client, // thirdweb client
    			fromCurrencySymbol: "USD", // fiat currency symbol
    			toChainId: arbnova.id, // arbitrum nova chain id
    			toAmount: "100", // amount of token to buy
    			toTokenAddress: USDC_TOKEN_ADDRESS, // address of payment token
    			fromAddress: "<USERS_WALLET_ADDRESS>",
    			toAddress: "<YOUR_WALLET_ADDRESS>",
    				purchaseData: {
    					nftId: 1
    				}
    			});
    		```

| Parámetro           | Tipo      | Descripción                                                                                                                                                 |
|---------------------|-----------|-------------------------------------------------------------------------------------------------------------------------------------------------------------|
| fromCurrencySymbol  | `string`  | El símbolo de la moneda fiat que deseas aceptar (actualmente limitado a USD y EUR).                                                                          |
| toChainId           | `string`  | [ID de la cadena](https://thirdweb.com/chainlist) para el token de destino.                                                                                  |
| toTokenAddress      | `string`  | Dirección del token de destino.                                                                                                                             |
| toAmount            | `string`  | El precio del activo denominado en tu token de destino.                                                                                                     |
| fromAddress         | `string`  | La dirección de la billetera del usuario.                                                                                                                   |
| toAddress           | `string`  | La billetera a la que deseas que se envíen los fondos. Esto puede ser tu billetera de negocios o una billetera de backend de Engine.                         |
| purchaseData        | `Object`  | Cualquier detalle que necesites pasar para rastrear tu transacción. Si es una reventa, podrías incluir detalles como `{ nftId: 1, orderId: 1 }`.              |

</Step>
<Step title="Integrar thirdweb Pay (Servidor)">
	1. Inicia sesión y crea un webhook de "Compra completada" en tu página Equipo > Conectar > Pay > Webhooks.
	2. La [respuesta POST del webhook de Pay](/connect/pay/webhooks#purchase-complete) incluirá el `BuyWithCryptoStatus` o `BuyWithFiatStatus` en el cuerpo.
		* Esto también incluirá el `purchaseData` que enviaste previamente (metadatos que identifican la información del cliente, etc.).
		* Se enviará una solicitud cada vez que el estado cambie.
	3. Escucha los [estados de compra completados](https://portal.thirdweb.com/connect/pay/build-a-custom-experience#Poll%20for%20Transaction%20Status). Nota que si se trata de una transacción de dos pasos con `BuyWithFiat` (onramp, luego swap), también deberías escuchar el estado `CRYPTO_SWAP_COMPLETED`.
	4. Cuando se complete una compra, identifica al comprador, el pedido y valida los montos.
		- El `fromAddress` en el estado mostrará la dirección que realizó la compra.
		- El `purchaseData` contendrá más información previamente pasada sobre los detalles de la compra.
		- Valida la información. Por ejemplo, verifica que se enviaron 100 USDC a tu billetera.
	5. Envía una llamada de contrato a Engine para que la billetera float realice la compra del artículo.
		- Por ejemplo, envía una transacción a la billetera float para `mintTo(fromAddress)`.
		- Para compras secundarias, como una lista directa en un marketplace, puedes usar el endpoint apropiado de Engine, pasando al comprador como el destinatario final del NFT.
	6. Confirma que la compra se realizó con éxito.
</Step>

</Steps>

Una vez que hayas completado todos estos pasos, estarás listo para ofrecer una experiencia de compra excepcional a tus usuarios.
