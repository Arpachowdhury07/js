import { ExternalLink } from "lucide-react";
import { Stack, ArticleIconCard } from "@doc";
import { TypeScriptIcon } from "@/icons";
import { createMetadata } from "@doc";

export const metadata = createMetadata({
	title: "Sign in with Ethereum",
	description: "Authenticate users with your backend securely by proving they own a given Ethereum address.",
});

# Sign in with Ethereum

Autentica a los usuarios de forma segura con tu backend probando que poseen una dirección Ethereum dada.

SIWE (Sign-In with Ethereum) permite a cualquier persona integrar autenticación y autorización sin contraseña basada en web3 en sus aplicaciones. Los usuarios pueden iniciar sesión utilizando cualquier billetera (in-app, externa o billetera inteligente).

Esto permite a los desarrolladores crear un flujo de autenticación familiar y seguro que funciona con backends tradicionales mientras aprovecha las características de una aplicación web3.

## Live Playground

Prueba la autenticación SIWE por ti mismo en el [auth live playground](https://playground.thirdweb.com/connect/auth)

<Stack>

<ArticleIconCard
	title="Try the demo"
	icon={ExternalLink}
	href="https://playground.thirdweb.com/connect/connect/auth"
	description="See the SDK in action on the live playground"
/>

</Stack>

## Configurando la autenticación de thirdweb

En tu backend, configura el objeto de autenticación con la función `createAuth`.

```tsx
import { createThirdwebClient } from "thirdweb";
import { createAuth } from "thirdweb/auth";
 
const client = createThirdwebClient({
  secretKey, // always use secret key for backend code
});
 
const thirdwebAuth = createAuth({
  domain: "localhost:3000", // your domain
  client,
  // your backend wallet to sign login payloads
  adminAccount: privateKeyToAccount({ client, privateKey }),
});
```

The `createAuth` helper returns an object with all the functions you will need to authenticate users. Check out the [createAuth API reference](https://portal.thirdweb.com/auth/siwe) for more details.

<Stack>

<ArticleIconCard
	title="createAuth"
	icon={TypeScriptIcon}
	href="/references/typescript/v5/createAuth"
	description="See the SDK in action on the live playground"
/>

</Stack>

Tu backend puede usar esas funciones para exponer un flujo de inicio de sesión compatible con SIWE a tu frontend.

Aquí tienes un ejemplo utilizando acciones de servidor y un JWT para la gestión de sesiones:

```tsx
export async function generatePayload(params) {
    // generates a SIWE compliant login payload to return to the client
    return thirdwebAuth.generatePayload(params);
}

export async function login(params) {
    // verify the user's signature
    const verifiedPayload = await thirdwebAuth.verifyPayload(params);
    if (verifiedPayload.valid) {
        // generate a JWT for the client (or use your own method to store the user session)
        const jwt = await thirdwebAuth.generateJWT({ payload: verifiedPayload });
        // set the JWT in cookies, or return it to the client to use as needed
        setJWTCookie(jwt);
        return true;
    } else {
        // the payload is not valid, you can return an error message to the client
        return false;
    }
}

export async function getUser() {
    // check if the user is logged in with cookies, storage, or your method of choice
    const jwt = getJWTCookie();
    const { valid, parsedJWT } = await thirdwebAuth.verifyJWT({ jwt });
    if (valid) {
      return authResult.parsedJWT.sub; // sub is the user's address
    }
    return null;
}

export async function logout() {
    // logout the user, delete cookies, etc.
}
```

## Uso con componentes de UI

Luego, puedes agregar un paso SIWE al flujo de conexión del componente de UI `ConnectWallet` o `ConnectEmbed` configurando la opción `auth`. Esto activará automáticamente la firma del payload de inicio de sesión devuelto por `getLoginPayload` y activará la función `doLogin` que implementaste en tu backend.

```tsx
import { ThirdwebProvider, ConnectButton } from "thirdweb/react";
import {
  generatePayload,
  getUser,
  login,
  logout,
} from "@/server/actions/auth";

export default function App() {
  const [loggedIn, setLoggedIn] = useState(false);
  return (
    // El ThirdwebProvider debe estar en la raíz de tu aplicación, pero el ConnectButton puede estar en cualquier parte
    <ThirdwebProvider>
      <ConnectButton
        client={client}
        auth={{
          getLoginPayload: async (params) => {
            // Aquí debes llamar a tu backend, usando generatePayload para devolver
            // un payload de inicio de sesión compatible con SIWE al cliente
            return generatePayload(params);
          },
          doLogin: async (params) => {
            // Aquí debes llamar a tu backend para verificar el payload firmado pasado en los parámetros
            // Esto verificará que la firma coincida con la billetera prevista
            return login(params);
          },
          isLoggedIn: async () => {
            // Aquí debes preguntar a tu backend si el usuario está logueado
            // Puedes usar cookies, almacenamiento o el método de tu preferencia
            const user = await getUser();
            return !!user;
          },
          doLogout: async () => {
            // Aquí debes llamar a tu backend para cerrar la sesión del usuario si es necesario
            // y eliminar cualquier token de autenticación local
            return logout();
          },
        }}
      />
    </ThirdwebProvider>
  );
}
```

## Usando tu propia UI

Puedes usar la función [`signLoginPayload`](/references/typescript/v5/signLoginPayload) para activar la firma del payload de inicio de sesión por ti mismo. Esto puede ser útil si deseas usar una UI personalizada para el flujo de inicio de sesión. Puedes obtener la cuenta activa que firmará el payload desde el hook [`useActiveAccount`](/references/typescript/v5/useActiveAccount).

<Stack>

<ArticleIconCard
	title="signLoginPayload"
	icon={TypeScriptIcon}
	href="/references/typescript/v5/signLoginPayload"
	description="Ve el SDK en acción en el playground en vivo"
/>

</Stack>

